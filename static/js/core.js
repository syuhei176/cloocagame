/* Copyright (C) 2012 Technical Rockstars Co.,Ltd. All Rights Reserved. */function ArrowHead(a){this.type=a;this.path=new Array();}ArrowHead.NONE=0;ArrowHead.V=1;ArrowHead.prototype.draw=function(a,b,c){var d=c.x-b.x;var e=c.y-b.y;var f=(Math.atan2(e,d)-Math.PI/6)*180/Math.PI;if(this.type==ArrowHead.NONE){}else if(this.type==ArrowHead.V){a.translateCanvas({x:c.x,y:c.y});a.rotateCanvas({angle:f+5,x:0,y:0});a.drawLine({strokeStyle:"#000",strokeWidth:2,x1:-10,y1:-10,x2:0,y2:0,x3:-14,y3:0});a.restoreCanvas();a.restoreCanvas();}else if(this.type==ArrowHead.TRIANGLE)a.drawPolygon({strokeStyle:"#000",x:c.x,y:c.y,radius:10,sides:3,angle:f});else if(this.type==ArrowHead.BLACK_TRIANGLE)a.drawPolygon({fillStyle:"#000",x:c.x,y:c.y,radius:10,sides:3,angle:f});else if(this.type==ArrowHead.DIAMOND)a.drawPolygon({strokeStyle:"#000",x:c.x,y:c.y,radius:10,sides:4,angle:f});else if(this.type==ArrowHead.BLACK_DIAMOND)a.drawPolygon({fillStyle:"#000",x:c.x,y:c.y,radius:10,sides:4,angle:f});};ArrowHead.prototype.getPath=function(a,b){var c=new Array();var d=Math.PI/6;var e=10;var f=b.getX()-a.getX();var g=b.getY()-a.getY();var h=Math.atan2(g,f);var i=b.getX()-e*Math.cos(h+d);var j=b.getY()-e*Math.sin(h+d);var k=b.getX()-e*Math.cos(h-d);var l=b.getY()-e*Math.sin(h-d);if(type==ArrowType.V){c.push(new Point2D(i,j));c.push(new Point2D(b.getX(),b.getY()));c.push(new Point2D(k,l));c.push(new Point2D(b.getX(),b.getY()));c.push(new Point2D(i,j));}else if(type==ArrowType.TRIANGLE||type==ArrowType.BLACK_TRIANGLE){c.push(new Point2D(b.getX(),b.getY()));c.push(new Point2D(i,j));c.push(new Point2D(k,l));}else if(type==ArrowType.DIAMOND||type==ArrowType.BLACK_DIAMOND){c.push(new Point2D(b.getX(),b.getY()));c.push(new Point2D(i,j));var m=k-e*Math.cos(h+d);var n=l-e*Math.sin(h+d);c.push(new Point2D(m,n));c.push(new Point2D(k,l));}return c;};function download(a){window.open('/download/'+a);}function genbin(a){$.post('/compile_server/reserve',{pid:a,pname:g_projectinfo.name},function(a){if(a)console.log('url='+a);else window.alert('error');},"json");}function saveModel(){var a=g_projectinfo.id;Ext.MessageBox.show({title:'Please wait',msg:'Loading...',progressText:'Initializing...',width:300,progress:true,closable:false,animEl:'mb6'});if(_is_preview){var b=JSON.stringify(g_model);$.post('/preview-save',{id:g_metamodel_id,sample:b},function(a){if(a){console.log('saved json string = '+b);Ext.MessageBox.hide();}},"json");}else{g_model.id=a;var b=JSON.stringify(g_model);$.post('/psave',{pid:a,xml:b},function(a){if(a){console.log('saved json string = '+b);if(a.updated){g_projectinfo.xml=a.xml;readModel(a.xml);createModelExplorer();editortabpanel.update();}Ext.MessageBox.hide();}},"json");}}function loadModel(a){console.log('aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa');Ext.MessageBox.show({title:'Please wait',msg:'Loading...',progressText:'Initializing...',width:300,progress:true,closable:false,animEl:'mb6'});$.post('/pload',{pid:a},function(a){if(a){console.log('loaded json string = '+a.xml);g_projectinfo=a;console.log('service='+g_projectinfo.group.service);if(a.xml=='null'||a.xml==''){g_model=new Model();g_model.root=1;g_model.diagrams[1]=new Diagram(1);diagram_IdGenerator.setOffset(1);}else g_model=JSON.parse(a.xml);g_metamodel_id=a.metamodel_id;loadMetaModel(a.metamodel_id);diagram_IdGenerator.setOffset(g_projectinfo.id*10000);object_IdGenerator.setOffset(g_projectinfo.id*10000);property_IdGenerator.setOffset(g_projectinfo.id*10000);for(var b in g_model.diagrams){obj=g_model.diagrams[b];if(obj==null)continue;diagram_IdGenerator.setOffset(obj.id);}for(var b in g_model.objects){obj=g_model.objects[b];if(obj==null)continue;object_IdGenerator.setOffset(obj.id);calObjHeight(obj);}for(var b in g_model.relationships){obj=g_model.relationships[b];if(obj==null)continue;object_IdGenerator.setOffset(obj.id);}for(var b in g_model.properties){var c=g_model.properties[b];if(c==null)continue;property_IdGenerator.setOffset(c.id);}createModelExplorer();Ext.MessageBox.updateProgress(0.5,'50% completed');}},"json");}function loadMetaModel(a){alert('aaaaaaaaaaaaaaaa');Ext.MessageBox.show({title:'Please wait',msg:'Loading...',progressText:'Initializing...',width:300,progress:true,closable:false,animEl:'mb6'});$.post('/mload',{id:a},function(a){if(a){g_metamodelinfo=a;console.log('loaded json string = '+a.xml);if(a.xml==' '||a.xml==null||a.xml.length==0)g_metamodel=new MetaModel();else g_metamodel=JSON.parse(a.xml);g_config_of_template=a.template;for(var b=0;b<g_metamodel.metaobjects.length;b++)if(g_metamodel.metaobjects[b]!=null)metaobject_IdGenerator.setOffset(g_metamodel.metaobjects[b].id);Ext.MessageBox.hide();}},"json");}function Generate(a,b,c){Ext.MessageBox.show({title:'Please wait',msg:'Generating...',progressText:'Generating...',width:300,progress:true,closable:false,animEl:'mb6'});$.post('/gen',{pid:a,target:b},function(a){Ext.MessageBox.hide();Ext.MessageBox.alert('結果',a);if(c!=null)c(a.length<7);},"json").error(function(){alert("error");Ext.MessageBox.hide();});}function parseModelXML(a){var b=new DOMParser();var c=b.parseFromString(a,"text/xml");var d=c.getElementsByTagName("Model");var e=new Model();for(var f=0;f<d.length;f++){var g=d[f].getElementsByTagName("Diagram");for(var h=0;h<g.length;h++)e.root=parseDiagramXML(g[h]);}return e;}function parseDiagramXML(a){var b=new Diagram();var c=a.getElementsByTagName("Object");for(var d=0;d<c.length;d++)b.objects.push(parseObjectXML(c[d]));var e=a.getElementsByTagName("Relationship");for(var d=0;d<e.length;d++){}return b;}function parseObjectXML(a){var b=new Object();var c=a.getElementsByTagName("Property");for(var d=0;d<c.length;d++){}return b;}function parseRelationshipXML(a){var b=new Relationship();var c=a.getElementsByTagName("Property");for(var d=0;d<c.length;d++){}return b;}function ModelController(){}ModelController.getObject=function(a,b){return g_model.objects[b];};ModelController.addDiagram=function(a){var b=new Diagram();b.meta_id=a;g_model.diagrams[b.id]=b;var c=new DiagramController(b);c.addElement(b,g_metamodel.metadiagrams[b.meta_id]);console.log('add diagram id='+b.id);return b;};ModelController.deleteDiagram=function(a){console.log('delete diagram id='+a+','+g_model.diagrams[a].ve.ver_type);if(g_model.diagrams[a].ve.ver_type=='add')delete g_model.diagrams[a];else g_model.diagrams[a].ve.ver_type='delete';createModelExplorer();};function DiagramController(a){this.diagram=a;this.listeners=new Array();}DiagramController.prototype.deleteObject=function(a){console.log('delete object id='+a+','+g_model.objects[a].ve.ver_type);if(g_model.objects[a].ve.ver_type=='add'){for(var b=0;b<this.diagram.objects.length;b++)if(this.diagram.objects[b]==a)this.diagram.objects.splice(b,1);delete g_model.objects[a];}else{g_model.objects[a].ve.ver_type='delete';VersionElement.update(this.diagram.ve);}var c=[];for(var b=0;b<this.diagram.relationships.length;b++){var d=this.diagram.relationships[b];if(g_model.relationships[d].src==a||g_model.relationships[d].dest==a)c.push(d);}for(var b=0;b<c.length;b++)this.deleteRelationship(c[b]);};DiagramController.prototype.deleteRelationship=function(a){console.log('delete relationship id='+a+','+g_model.relationships[a].ve.ver_type);if(g_model.relationships[a].ve.ver_type=='add'){for(var b=0;b<this.diagram.relationships.length;b++)if(this.diagram.relationships[b]==a)this.diagram.relationships.splice(b,1);delete g_model.relationships[a];}else{g_model.relationships[a].ve.ver_type='delete';VersionElement.update(this.diagram.ve);}};DiagramController.prototype.addObject=function(a,b,c){obj=new Object(c);obj.bound.x=a;obj.bound.y=b;obj.ve.ver_type='add';VersionElement.update(this.diagram.ve);g_model.objects[obj.id]=obj;this.diagram.objects.push(obj.id);this.addElement(obj,g_metamodel.metaobjects[obj.meta_id]);console.log('add object id='+obj.id+','+obj.ve.ver_type);for(var d=0;d<this.diagram.objects.length;d++){var e=this.diagram.objects[d];var f=g_model.objects[e];if(f!=obj&&f.ofd.z>=obj.ofd.z)obj.ofd.z=f.ofd.z+1;}return obj;};DiagramController.prototype.addRelationship=function(a,b,c){var d=this.findNode(a);var e=this.findNode(b);if(this.checkBinding(g_metamodel.metaobjects[d.meta_id],g_metamodel.metaobjects[e.meta_id],g_metamodel.metarelations[c])==false)return null;if(d!=null&&e!=null){var f=new Relationship(c);f.src=d.id;f.dest=e.id;f.ve.ver_type='add';VersionElement.update(this.diagram.ve);if(f.src==f.dest){f.points.push(new Point2D(d.bound.x+10,d.bound.y+50));f.points.push(new Point2D(d.bound.x+50,d.bound.y+50));f.points.push(new Point2D(d.bound.x+50,d.bound.y+10));}g_model.relationships[f.id]=f;this.diagram.relationships.push(f.id);this.addElement(f,g_metamodel.metarelations[f.meta_id]);console.log('add relationship id='+f.id+','+f.ve.ver_type);return f;}return null;};DiagramController.prototype.addElement=function(a,b){for(var c=0;c<b.properties.length;c++){var d=g_metamodel.metaproperties[b.properties[c]];var e=null;for(var f=0;f<a.properties.length;f++)if(a.properties[f].meta_id==b.properties[c])e=a.properties[f];if(e==null){plist=new PropertyList();plist.meta_id=d.id;if(d.data_type!=MetaProperty.COLLECTION_STRING)this.addProperty(plist,d,'');a.properties.push(plist);}}if(b.visible){}};DiagramController.prototype.updateObject=function(a,b,c){a.bound.x+=b;a.bound.y+=c;VersionElement.update(a.ve);};DiagramController.prototype.addProperty=function(a,b,c){var d=new Property();d.meta_id=b.id;if(c!=undefined)d.value=c;g_model.properties[d.id]=d;a.children.push(d.id);if(b.data_type==MetaProperty.NUMBER)d.value=0;else d.value=c;console.log('add property id='+d.id+','+d.ve.ver_type);};DiagramController.prototype.deleteProperty=function(){console.log('add property id='+new_p.id+','+new_p.ve.ver_type);};DiagramController.prototype.updateProperty=function(a,b,c){a.value=b;VersionElement.update(a.ve);this.fireUpdateProperty(a,b,c);};DiagramController.prototype.findNode=function(a){var b=[];for(var c=0;c<this.diagram.objects.length;c++){var d=this.diagram.objects[c];var e=g_model.objects[d];if(e==undefined)alert(d);b.push(e);}b.sort(function(a,b){return b.ofd.z-a.ofd.z;});for(var c=0;c<b.length;c++){var e=b[c];if(Rectangle2D.contains(e.bound,a))return e;}return null;};DiagramController.prototype.on=function(a,b){this.listeners.push({event:a,fn:b});};DiagramController.prototype.fireUpdateProperty=function(a,b,c){for(var d=0;d<this.listeners.length;d++)if(this.listeners[0].event=='updateProperty')this.listeners[0].fn(a,b,c);};DiagramController.prototype.checkBinding=function(a,b,c){if(c.bindings==undefined)return true;if(c.bindings.length==0)return true;for(var d=0;d<c.bindings.length;d++)if(c.bindings[d].src==a.id&&c.bindings[d].dest==b.id)return true;return false;};function DiagramEditor(a,b,c){this.name=a;this.key=b;this.diagram=c;this.diagramController=new DiagramController(this.diagram);this.tool=null;this.drag_start=new Point2D();this.drag_move_prev=new Point2D();this.drag_move=new Point2D();this.drag_end=new Point2D();this.selected=null;this.dragMode=0;this.select_button=null;this.copied_elem=null;var d=this;this.diagramController.on('updateProperty',function(a,b,c){if(c.bound!=undefined)calObjHeight(c);d.draw();});this.width=500;this.height=500;for(var e=0;e<this.diagram.objects.length;e++){var f=this.diagram.objects[e];if(this.width<g_model.objects[f].bound.x+g_model.objects[f].bound.width+50)this.width=g_model.objects[f].bound.x+g_model.objects[f].bound.width+50;if(this.height<g_model.objects[f].bound.y+g_model.objects[f].bound.height+50)this.height=g_model.objects[f].bound.y+g_model.objects[f].bound.height+50;}console.log('width='+this.width+',height='+this.height);this.panel=Ext.create('Ext.panel.Panel',{id:'de_'+this.key,title:a,autoScroll:true,html:'<canvas id="canvas_'+this.key+'" width='+this.width+' height='+this.height+'></canvas>',closable:g_editor_option.tab_closable});this.canvas=$('#canvas_'+this.key);}DiagramEditor.prototype.changeCanvasSize=function(a,b){};DiagramEditor.prototype.changeCanvasWidth=function(a){this.width=Number(a);var b=document.getElementById('canvas_'+this.key);b.width=this.width;};DiagramEditor.prototype.changeCanvasHeight=function(a){this.height=Number(a);var b=document.getElementById('canvas_'+this.key);b.width=this.height;};DiagramEditor.prototype.onUpdate=function(){this.diagram=g_model.diagrams[this.diagram.id];this.diagramController=new DiagramController(this.diagram);};DiagramEditor.prototype.draw=function(){var a=this;if(this.canvas==null||this.canvas==undefined)this.canvas=$('#canvas_'+this.key);a.canvas.drawRect({fillStyle:"#fff",x:0,y:0,width:a.width,height:a.height,fromCenter:false});var b=[];for(var c=0;c<this.diagram.objects.length;c++){var d=this.diagram.objects[c];var e=g_model.objects[d];if(e==undefined)alert(d);b.push(e);}b.sort(function(a,b){return a.ofd.z-b.ofd.z;});for(var c=0;c<b.length;c++){var d=b[c].id;var e=b[c];this.draw_object(e);}for(var c=0;c<a.diagram.relationships.length;c++){var f=a.diagram.relationships[c];var g=g_model.relationships[f];if(g.ve.ver_type=='delete')continue;a.draw_relationship(g);}if(a.tool!=null)a.canvas.drawText({fillStyle:"#000",x:a.drag_move.x,y:a.drag_move.y,text:a.tool.name,align:"center",baseline:"middle",font:"16px 'ＭＳ ゴシック'"});if(a.dragMode==DiagramEditor.DRAG_RUBBERBAND)a.canvas.drawLine({strokeStyle:"#777",strokeWidth:2,strokeCap:"round",strokeJoin:"miter",x1:a.drag_start.x,y1:a.drag_start.y,x2:a.drag_move.x,y2:a.drag_move.y});else if(a.dragMode==DiagramEditor.DRAG_RANGE)a.canvas.drawRect({strokeStyle:"#00f",strokeWidth:2,x:this.drag_start.x,y:this.drag_start.y,width:this.drag_move.x-this.drag_start.x,height:this.drag_move.y-this.drag_start.y,fromCenter:false});};DiagramEditor.prototype.getPanel=function(){return this.panel;};DiagramEditor.prototype.Initialize=function(){var a=this;this.canvas=$('#canvas_'+this.key);var b=new Ext.menu.Menu({items:[{id:'delete_element',text:'削除'},{id:'delete_point',text:'ポイントを削除'},{id:'copy',text:'コピー'},{id:'paste',text:'ペースト'},{id:'up_step',text:'一つ上へ'},{id:'down_step',text:'一つ下へ'},{id:'diagram',text:'関連する図を作成'}],listeners:{click:function(b,c){switch(c.id){case 'delete_element':a.deleteSelected();break;case 'delete_point':a.deletePoint();break;case 'copy':a.copyObject();break;case 'paste':a.pasteObject(a.drag_start.x,a.drag_start.y);break;case 'up_step':a.up_step();break;case 'down_step':a.down_step();break;case 'diagram':if(current_editor!=null&&current_editor.selected!=null&&g_metamodel.metaobjects[current_editor.selected.meta_id].decomposition!=null&&current_editor.selected.diagram==null){var d=ModelController.addDiagram(g_metamodel.metaobjects[current_editor.selected.meta_id].decomposition);current_editor.selected.diagram=d.id;change_diagram_name_view(d);}break;}}}});if(navigator.userAgent.indexOf('iPad')>0){this.canvas.touchmove(function(b){var c=b.target.getBoundingClientRect();mouseX=b.clientX-c.left;mouseY=b.clientY-c.top;a.ActionMove(mouseX,mouseY);});this.canvas.touchstart(function(c){var d=c.target.getBoundingClientRect();mouseX=c.clientX-d.left;mouseY=c.clientY-d.top;if(c.button==2)b.showAt(c.clientX,c.clientY);else{a.ActionDown(mouseX,mouseY);a.draw();}});this.canvas.touchend(function(b){var c=b.target.getBoundingClientRect();mouseX=b.clientX-c.left;mouseY=b.clientY-c.top;a.ActionUp(mouseX,mouseY);a.draw();});}else{this.canvas.mousemove(function(b){var c=b.target.getBoundingClientRect();mouseX=b.clientX-c.left;mouseY=b.clientY-c.top;a.ActionMove(mouseX,mouseY);});this.canvas.mousedown(function(c){var d=c.target.getBoundingClientRect();mouseX=c.clientX-d.left;mouseY=c.clientY-d.top;if(c.button==2)b.showAt(c.clientX,c.clientY);else{a.ActionDown(mouseX,mouseY);a.draw();}});this.canvas.mouseup(function(b){var c=b.target.getBoundingClientRect();mouseX=b.clientX-c.left;mouseY=b.clientY-c.top;a.ActionUp(mouseX,mouseY);a.draw();});}this.draw();};DiagramEditor.prototype.onActivate=function(){this.createButton();current_editor=this;};DiagramEditor.DRAG_NONE=0;DiagramEditor.DRAG_RUBBERBAND=1;DiagramEditor.DRAG_MOVE=2;DiagramEditor.DRAG_POINT=3;DiagramEditor.DRAG_RANGE=4;DiagramEditor.DRAG_RESIZE=5;DiagramEditor.DRAG_RANGE=6;DiagramEditor.prototype.ActionMove=function(a,b){this.drag_move.x=a;this.drag_move.y=b;if(this.dragMode==DiagramEditor.DRAG_MOVE){if(this.selected!=null){if(this.selected instanceof Array)for(var c=0;c<this.selected.length;c++)this.updateObject(this.selected[c],Number(this.drag_move.x-this.drag_move_prev.x),Number(this.drag_move.y-this.drag_move_prev.y));else this.updateObject(this.selected,Number(this.drag_move.x-this.drag_move_prev.x),Number(this.drag_move.y-this.drag_move_prev.y));this.draw();}}else if(this.dragMode==DiagramEditor.DRAG_RUBBERBAND)this.draw();else if(this.dragMode==DiagramEditor.DRAG_RESIZE){if(this.selected instanceof Array){}else{this.selected.bound.width=this.drag_move.x-this.selected.bound.x;this.selected.bound.height=this.drag_move.y-this.selected.bound.y;if(this.selected.bound.width<16)this.selected.bound.width=16;if(this.selected.bound.height<16)this.selected.bound.height=16;}this.draw();}else if(this.dragMode==DiagramEditor.DRAG_RANGE)this.draw();else{}this.drag_move_prev.x=this.drag_move.x;this.drag_move_prev.y=this.drag_move.y;};DiagramEditor.prototype.updateObject=function(a,b,c){this.diagramController.updateObject(a,b,c);if(this.width<a.bound.x+a.bound.width+32)this.changeCanvasWidth(a.bound.x+a.bound.width+32);if(this.height<a.bound.y+a.bound.height+32)this.changeCanvasHeight(a.bound.y+a.bound.height+32);};DiagramEditor.prototype.ActionDown=function(a,b){if(this.tool==null)if(this.clicknode(Number(a),Number(b))){if(this.dragMode!=DiagramEditor.DRAG_RESIZE)this.dragMode=DiagramEditor.DRAG_MOVE;}else if(this.clickedge(a,b)){}else{this.dragMode=DiagramEditor.DRAG_RANGE;this.selected=null;}else if(this.tool.classname=='MetaObject'){this.diagramController.addObject(a,b,this.tool.id);this.select_button.toggle(true,false);}else if(this.tool.classname=='MetaRelation')this.dragMode=DiagramEditor.DRAG_RUBBERBAND;this.drag_start.x=a;this.drag_start.y=b;};DiagramEditor.prototype.ActionUp=function(a,b){this.drag_end.x=a;this.drag_end.y=b;if(this.dragMode==DiagramEditor.DRAG_RUBBERBAND){this.diagramController.addRelationship(this.drag_start,this.drag_end,this.tool.id);this.select_button.toggle(true);}else if(this.dragMode==DiagramEditor.DRAG_POINT){if(this.selected instanceof Array==false)this.movePoint(this.selected,this.drag_start,this.drag_end);}else if(this.dragMode==DiagramEditor.DRAG_RANGE)this.selectRange(this.drag_start,this.drag_end);this.dragMode=DiagramEditor.DRAG_NONE;};DiagramEditor.prototype.copyObject=function(){if(this.selected instanceof Array){this.copied_elem=[];for(var a=0;a<this.selected.length;a++){var b=this.selected[a];if(b.ofd==undefined)return;this.copied_elem.push(b);}}else{this.copied_elem=null;var b=this.selected;if(b.ofd==undefined)return;this.copied_elem=b;}};DiagramEditor.prototype.pasteObject=function(a,b){if(this.copied_elem!=null&&this.copied_elem instanceof Array==false){var c=this.diagramController.addObject(a,b,this.copied_elem.meta_id);for(var d=0;d<c.properties.length;d++){var e=null;for(var f=0;f<this.copied_elem.properties.length;f++)if(this.copied_elem.properties[f].meta_id==c.properties[d].meta_id){e=this.copied_elem.properties[f];break;}var g=c.properties[d];while(g.children.length<e.children.length)this.diagramController.addProperty(g,g_metamodel.metaproperties[e.meta_id],'');for(var f=0;f<e.children.length;f++)this.diagramController.updateProperty(g_model.properties[g.children[f]],g_model.properties[e.children[f]].value,c);}}};DiagramEditor.prototype.deletePoint=function(){if(this.selected instanceof Array){}else{var a=this.selected;if(a==null)return;a.points.length=0;}};DiagramEditor.prototype.movePoint=function(a,b,c){if(a!=null){var d=true;for(var e=0;e<a.points.length;e++)if(Point2D.distanceSq(a.points[e],b)<150){a.points[e].x=c.x;a.points[e].y=c.y;d=false;}if(d)if(a.points.length<2)a.points.push(new Point2D(c.x,c.y));}};DiagramEditor.prototype.selectRange=function(a,b){var c;var d,e,f,g;if(a.x>b.x){d=b.x;f=a.x-b.x;}else{d=a.x;f=b.x-a.x;}if(a.y>b.y){e=b.y;g=a.y-b.y;}else{e=a.y;g=b.y-a.y;}var c=new Rectangle2D(d,e,f,g);this.selected=[];for(var h=0;h<this.diagram.objects.length;h++){var i=this.diagram.objects[h];var j=g_model.objects[i];if(j==undefined)alert(i);if(j.ve.ver_type=='delete')continue;if(Rectangle2D.contains(c,new Point2D(j.bound.x,j.bound.y)))if(Rectangle2D.contains(c,new Point2D(j.bound.x+j.bound.width,j.bound.y+j.bound.height)))this.selected.push(j);}if(this.selected.length==0)this.selected=null;};DiagramEditor.prototype.clicknode=function(a,b){if(this.selected instanceof Array){var c=this.diagramController.findNode(new Point2D(a,b));if(c!=null)for(var d=0;d<this.selected.length;d++)if(c.id==this.selected[d].id)return true;return false;}else{var c=this.diagramController.findNode(new Point2D(a,b));if(c!=null){var e=null;if(this.clickedge(a,b)){e=this.selected;this.selected=null;}if(c==this.selected)if(Rectangle2D.contains(new Rectangle2D(c.bound.x+c.bound.width-12,c.bound.y+c.bound.height-12,12,12),new Point2D(a,b)))this.dragMode=DiagramEditor.DRAG_RESIZE;if(c.ve.ver_type=="delete")return false;if(e!=null)if(c.ofd.z<g_model.objects[e.src].ofd.z&&c.ofd.z<g_model.objects[e.dest].ofd.z)return false;this.selected=c;this.fireSelectObject(this.selected);return true;}return false;}};DiagramEditor.prototype.clickedge=function(a,b){for(var c=0;c<this.diagram.relationships.length;c++)if(this.click_a_edge(g_model.relationships[this.diagram.relationships[c]],a,b))return true;return false;};DiagramEditor.prototype.click_a_edge=function(a,b,c){if(a.ve.ver_type=="delete")return false;var d=new Array();var e=ModelController.getObject(this.diagram,a.src);var f=ModelController.getObject(this.diagram,a.dest);var g=new Point2D((e.bound.x+e.bound.width/2),(e.bound.y+e.bound.height/2));var h=new Point2D((f.bound.x+f.bound.width/2),(f.bound.y+f.bound.height/2));d.push(g);d=d.concat(a.points);d.push(h);for(var i=0;i<d.length-1;i++)if(new Line2D(d[i].x,d[i].y,d[i+1].x,d[i+1].y).ptSegDist(b,c)<16){if(a==this.selected)this.dragMode=DiagramEditor.DRAG_POINT;this.selected=a;this.fireSelectRelationship(this.selected);return true;}return false;};DiagramEditor.prototype.createButton=function(){var a=this;var b=Ext.getCmp('toolpanel');b.removeAll();var c=[];this.metadiagram=g_metamodel.metadiagrams[this.diagram.meta_id];for(var d=0;d<this.metadiagram.metaobjects.length;d++)c.push(g_metamodel.metaobjects[this.metadiagram.metaobjects[d]]);for(var d=0;d<this.metadiagram.metarelations.length;d++)c.push(g_metamodel.metarelations[this.metadiagram.metarelations[d]]);c.unshift(null);for(var d=0;d<c.length;d++){var e='';if(c[d]==null)e='select';else e=c[d].name;var f=Ext.create('Ext.Button',{text:e,width:100,height:32,enableToggle:true,toggleGroup:'tools',listeners:{click:function(){},toggle:function(b,d){if(d){var e=c[this.index];a.tool=e;}},mouseover:function(){}}});if(f.text=='select')this.select_button=f;f.index=d;b.add(f);}};DiagramEditor.prototype.deleteSelected=function(){if(this.selected!=null){for(var a=0;a<this.diagram.objects.length;a++)if(this.diagram.objects[a]==this.selected.id)this.diagramController.deleteObject(this.selected.id);for(var a=0;a<this.diagram.relationships.length;a++)if(this.diagram.relationships[a]==this.selected.id)this.diagramController.deleteRelationship(this.selected.id);this.draw();}};DiagramEditor.prototype.info=function(){if(this.selected!=null){var a='ver_type='+this.selected.ve.ver_type;a+='<br>version='+this.selected.ve.version;a+='<br>id='+this.selected.id;a+='<br>pid='+Math.floor(this.selected.id/10000);if(this.selected.ofd!=undefined)a+='<br>z='+this.selected.ofd.z;Ext.getCmp('element-infomation').removeAll();Ext.getCmp('element-infomation').add({html:a});}};DiagramEditor.prototype.most_up_step=function(){};DiagramEditor.prototype.most_down_step=function(){};DiagramEditor.prototype.up_step=function(){if(this.selected.ofd!=undefined){for(var a=0;a<this.diagram.objects.length;a++){var b=this.diagram.objects[a];var c=g_model.objects[b];if(c.ofd.z==this.selected.ofd.z+1)c.ofd.z--;}if(this.selected!=null)this.selected.ofd.z++;}else if(this.selected.rfd!=undefined){for(var a=0;a<this.diagram.relationships.length;a++){var d=this.diagram.relationships[a];var e=g_model.relationships[d];if(e.rfd.z==this.selected.rfd.z+1)e.rfd.z--;}if(this.selected!=null)this.selected.rfd.z++;}};DiagramEditor.prototype.down_step=function(){if(this.selected.ofd!=undefined){for(var a=0;a<this.diagram.objects.length;a++){var b=this.diagram.objects[a];var c=g_model.objects[b];if(c.ofd.z==this.selected.ofd.z-1)c.ofd.z++;}if(this.selected!=null){this.selected.ofd.z--;console.log('down');}}else if(this.selected.rfd!=undefined){for(var a=0;a<this.diagram.relationships.length;a++){var d=this.diagram.relationships[a];var e=g_model.relationships[d];if(e.rfd.z==this.selected.rfd.z-1)e.rfd.z++;}if(this.selected!=null)this.selected.rfd.z--;}};DiagramEditor.prototype.fireSelectObject=function(a){var b=MetaModelController.getMetaObject(g_metamodel.metadiagram,a.meta_id);this.createPropertyPanel(b,a);this.info();};DiagramEditor.prototype.fireSelectRelationship=function(a){var b=MetaModelController.getMetaRelation(g_metamodel.metadiagram,a.meta_id);this.createPropertyPanel(b,a);this.info();};DiagramEditor.prototype.createPropertyPanel=function(a,b){var c=null;if(arguments.length==3)c=arguments[2];var d=this;Ext.getCmp('propertypanel').removeAll();var e=Ext.create('Ext.tab.Panel',{items:[]});for(var f=0;f<a.properties.length;f++){var g=g_metamodel.metaproperties[a.properties[f]];var h=null;for(var i=0;i<b.properties.length;i++)if(b.properties[i].meta_id==a.properties[f])h=b.properties[i];if(h==null){plist=new PropertyList();plist.meta_id=g.id;if(g.data_type!=MetaProperty.COLLECTION_STRING)this.diagramController.addProperty(plist,g);b.properties.push(plist);h=plist;}var j=null;if(g.data_type==MetaProperty.COLLECTION_STRING)j=PropertyPanel.CollectionString(this,g,h,b,a);else if(g.widget==MetaProperty.INPUT_FIELD)j=PropertyPanel.InputField(this,g,h,b);else if(g.widget==MetaProperty.FIXED_LIST)j=PropertyPanel.FixedList(this,g,h,b);j.index=f;e.add(j);if(g.id==c)e.setActiveTab(j);}if(a.decomposition!=undefined)e.add(PropertyPanel.Decomposition(this,a,b));Ext.getCmp('propertypanel').add(e);};DiagramEditor.prototype.getImage=function(a){window.open(this.canvas.getCanvasImage(a));};function PropertyPanel(){}PropertyPanel.Decomposition=function(a,b,c){var d=[];for(var e in g_model.diagrams){var f=g_model.diagrams[e].properties[0];dname=g_model.properties[f.children[0]].value;console.log(dname);d.push({id:g_model.diagrams[e].id,name:dname});}var g=Ext.create('Ext.data.Store',{fields:['id','name'],data:d});var h={title:'diagram',html:'',items:[{xtype:'combobox',store:g,queryMode:'local',displayField:'name',valueField:'id',value:c.diagram,listeners:{change:{fn:function(a,b,d,e){c.diagram=Number(b);}}}}]};return h;};PropertyPanel.InputField=function(a,b,c,d){var e=g_model.properties[c.children[0]];var f='textfield';if(b.data_type.toLowerCase()==MetaProperty.STRING)f='textfield';else if(b.data_type.toLowerCase()==MetaProperty.NUMBER)f='numberfield';var g={title:b.name,html:'',items:[{xtype:f,value:e.value,listeners:{change:{fn:function(b,c,f,g){a.diagramController.updateProperty(e,c,d);}}}}]};return g;};PropertyPanel.FixedList=function(a,b,c,d){var e=g_model.properties[c.children[0]];var f=Ext.create('Ext.data.Store',{fields:['disp','value'],data:b.exfield});var g={title:b.name,html:'',items:[{xtype:'combobox',store:f,queryMode:'local',displayField:'disp',valueField:'value',value:e.value,listeners:{change:{fn:function(b,f,g,h){g_model.properties[c.children[0]].value=f;a.diagramController.updateProperty(e,f,d);}}}}]};return g;};PropertyPanel.selected=new Array();PropertyPanel.CollectionString=function(a,b,c,d,e){var f=Ext.create('Ext.selection.CheckboxModel',{listeners:{selectionchange:function(a,b){n.down('#removeButton').setDisabled(b.length==0);for(var c=0;c<b.length;c++){PropertyPanel.selected=new Array();PropertyPanel.selected.push(b[c].get('index'));}}}});Ext.define('Collection',{extend:'Ext.data.Model',fields:['value']});var g=new Array();for(var h=0;h<c.children.length;h++){var i=g_model.properties[c.children[h]];if(i.ve.ver_type!='delete')g.push({id:i.id,index:h,value:i.value});}var j=Ext.create('Ext.data.Store',{model:'Collection',data:g});var k=function(){Ext.Msg.prompt('追加','プロパティ',function(f,g){if(f!='cancel'){a.diagramController.addProperty(c,b,g);if(d.bound!=undefined)calObjHeight(d);current_editor.createPropertyPanel(e,d,b.id);}},null,false,'');};var l=function(){var b=g_model.properties[c.children[PropertyPanel.selected[0]]];Ext.Msg.prompt('編集','プロパティ',function(b,e){if(b!='cancel'){var f=g_model.properties[c.children[PropertyPanel.selected[0]]];a.diagramController.updateProperty(f,e,d);}},null,false,b.value);};var m=function(){for(var a=0;a<PropertyPanel.selected.length;a++){if(i.ve.ver_type=='add'){delete g_model.properties[c.children[PropertyPanel.selected[a]]];c.children.splice(PropertyPanel.selected[a],1);}else g_model.properties[c.children[PropertyPanel.selected[a]]].ve.ver_type='delete';if(d.bound!=undefined)calObjHeight(d);current_editor.createPropertyPanel(e,d,b.id);}};var n=Ext.create('Ext.grid.Panel',{id:'property_collection_'+b.name,store:j,columns:[{text:"string",flex:1,sortable:true,dataIndex:'value'}],columnLines:true,selModel:f,dockedItems:[{xtype:'toolbar',dock:'bottom',ui:'footer',layout:{pack:'center'},items:[]},{xtype:'toolbar',items:[{text:'追加',tooltip:'Add a new row',iconCls:'add',handler:k},'-',{text:'編集',tooltip:'Set options',iconCls:'option',handler:l},'-',{itemId:'removeButton',text:'削除',tooltip:'Remove the selected item',iconCls:'remove',disabled:true,handler:m}]}],width:500,height:160,frame:true,title:b.name,iconCls:'icon-grid'});return n;};function calObjHeight(a){if(a.bound==undefined)return;if(g_metamodel.metaobjects[a.meta_id].resizable==true)return;var b=0;var c=4;for(var d=0;d<a.properties.length;d++){var e=a.properties[d];for(var f=0;f<e.children.length;f++){b++;var g=g_model.properties[e.children[f]];var h=g_metamodel.metaproperties[g.meta_id];var i=g.value;if(h.widget==MetaProperty.FIXED_LIST)for(var j=0;j<h.exfield.length;j++)if(g.value==h.exfield[j].value)i=h.exfield[j].disp;if(i!=undefined&&c<StrLen(i))c=StrLen(i);}}a.bound.height=b*20+10;a.bound.width=c*8+16;if(a.bound.height<12)a.bound.height=42;}function draw_dot_line(a,b,c,d){var e=Math.sqrt(Point2D.distanceSq(c,d));var f=(d.x-c.x)/e;var g=(d.y-c.y)/e;for(var h=0;h<e;h+=10){var i=c.x+f*h;var j=c.y+g*h;var k=c.x+f*(h+5);var l=c.y+g*(h+5);a.drawLine({strokeStyle:b,strokeWidth:2,x1:i,y1:j,x2:k,y2:l});}}DiagramEditor.prototype.draw_object=function(a){if(a.ve.ver_type=='delete')return;var b='#000';var c=false;if(this.selected instanceof Array){for(var d=0;d<this.selected.length;d++)if(a==this.selected[d]){b='#00f';c=true;break;}}else if(a==this.selected){b='#00f';c=true;}var e=g_metamodel.metaobjects[a.meta_id];if(e.graphic==null||e.graphic=='rect')this.canvas.drawRect({strokeStyle:b,strokeWidth:2,fillStyle:"#fff",x:a.bound.x,y:a.bound.y,width:a.bound.width,height:a.bound.height,fromCenter:false});else if(e.graphic=='package'){this.canvas.drawRect({strokeStyle:b,strokeWidth:2,fillStyle:"#fff",x:a.bound.x,y:a.bound.y-20,width:a.bound.width-30,height:20,fromCenter:false});this.canvas.drawRect({strokeStyle:b,strokeWidth:2,fillStyle:"#fff",x:a.bound.x,y:a.bound.y,width:a.bound.width,height:a.bound.height,fromCenter:false});}else if(e.graphic=='rounded')this.canvas.drawRect({strokeStyle:b,strokeWidth:2,x:a.bound.x,y:a.bound.y,width:a.bound.width,height:a.bound.height,fromCenter:false,cornerRadius:5});else if(e.graphic=='circle')$("canvas").drawArc({strokeStyle:'#000',strokeWidth:2,x:a.bound.x+a.bound.width/2,y:a.bound.y+a.bound.width/2,radius:a.bound.width/2,start:0,end:359,fromCenter:true});else if(e.graphic=='fillcircle')$("canvas").drawArc({fillStyle:'#000',strokeWidth:2,x:a.bound.x+a.bound.width/2,y:a.bound.y+a.bound.width/2,radius:a.bound.width/2,start:0,end:359,fromCenter:true});else if(e.graphic=='endcircle'){$("canvas").drawArc({strokeStyle:b,strokeWidth:2,x:a.bound.x+a.bound.width/2,y:a.bound.y+a.bound.width/2,radius:a.bound.width/2,start:0,end:359,fromCenter:true});$("canvas").drawArc({fillStyle:"#000",strokeWidth:2,x:a.bound.x+a.bound.width/2,y:a.bound.y+a.bound.width/2,radius:a.bound.width/2-5,start:0,end:359,fromCenter:true});}else{var f=g_metamodel.graphics[e.graphic];f.option.col='#000';f.option.strokeStyle='#000';if(f.type=='polygon'){this.canvas.translateCanvas({x:a.bound.x+a.bound.width/2,y:a.bound.y+a.bound.height/2});this.canvas.scaleCanvas({x:0,y:0,scaleX:a.bound.width/50,scaleY:a.bound.height/50});this.canvas.drawPolygon(f.option);this.canvas.restoreCanvas();this.canvas.restoreCanvas();}else if(f.type=='lines'){this.canvas.translateCanvas({x:a.bound.x+a.bound.width/2,y:a.bound.y+a.bound.width/2});this.canvas.scaleCanvas({x:0,y:0,scaleX:a.bound.width/50,scaleY:a.bound.height/50});this.canvas.drawLine(f.option);this.canvas.restoreCanvas();this.canvas.restoreCanvas();}else if(f.type=='src')this.canvas.drawImage({source:f.src,x:a.bound.x+a.bound.width/2,y:a.bound.y+a.bound.height/2,width:a.bound.width,height:a.bound.height});}if(c){this.canvas.drawRect({strokeStyle:'#00f',strokeWidth:2,x:a.bound.x,y:a.bound.y,width:a.bound.width,height:a.bound.height,fromCenter:false});if(e.resizable==true)this.canvas.drawRect({fillStyle:"#00f",strokeWidth:2,x:a.bound.x+a.bound.width-12,y:a.bound.y+a.bound.height-12,width:12,height:12,fromCenter:false});}var g=0;for(var d=0;d<e.properties.length;d++){var h=null;for(var i=0;i<a.properties.length;i++)if(a.properties[i].meta_id==e.properties[d])h=a.properties[i];if(h!=null){for(var j=0;j<h.children.length;j++){var k=g_model.properties[h.children[j]];if(k.ve.ver_type=='delete')continue;var l=k.value;var m=g_metamodel.metaproperties[h.meta_id];if(m.widget==MetaProperty.FIXED_LIST)for(var n=0;n<m.exfield.length;n++)if(k.value==m.exfield[n].value)l=m.exfield[n].disp;this.canvas.drawText({fillStyle:"#000",x:a.bound.x+a.bound.width/2,y:a.bound.y+g*20+20,text:l,align:"center",baseline:"middle",font:"16px 'ＭＳ ゴシック'"});g++;}if(e.properties.length-1!=d&&(e.graphic=='rect'||e.graphic=='rounded'))this.canvas.drawLine({strokeStyle:"#000",strokeWidth:2,x1:a.bound.x,y1:a.bound.y+g*20+10,x2:a.bound.x+a.bound.width,y2:a.bound.y+g*20+10});}}};DiagramEditor.prototype.draw_relationship=function(a){var b=g_metamodel.metarelations[a.meta_id];var c='#000';if(a==this.selected)c='#00f';if(a.ve.ver_type=='delete')return;var d=ModelController.getObject(this.diagram,a.src);var e=ModelController.getObject(this.diagram,a.dest);var f=new Point2D((d.bound.x+d.bound.width/2),(d.bound.y+d.bound.height/2));var g=new Point2D((e.bound.x+e.bound.width/2),(e.bound.y+e.bound.height/2));var h=0;var i=0;if(a.points.length==0){h=this.getConnectionPoint(new Line2D(f.x,f.y,g.x,g.y),d.bound);i=this.getConnectionPoint(new Line2D(g.x,g.y,f.x,f.y),e.bound);}else if(a.points.length>0){h=this.getConnectionPoint(new Line2D(f.x,f.y,a.points[0].x,a.points[0].y),d.bound);i=this.getConnectionPoint(new Line2D(g.x,g.y,a.points[a.points.length-1].x,a.points[a.points.length-1].y),e.bound);}var j=[];j.push(h);j=j.concat(a.points);j.push(i);for(var k=0;k<j.length-1;k++)if(b.dot)draw_dot_line(this.canvas,c,j[k],j[k+1]);else this.canvas.drawLine({strokeStyle:c,strokeWidth:2,strokeCap:"round",strokeJoin:"miter",x1:j[k].x,y1:j[k].y,x2:j[k+1].x,y2:j[k+1].y});var l=b.arrow_type;if(l=='v'){var m=new ArrowHead(ArrowHead.V);m.draw(this.canvas,j[j.length-2],j[j.length-1]);}else if(l=='TRIANGLE'){var m=new ArrowHead(ArrowHead.TRIANGLE);m.draw(this.canvas,j[j.length-2],j[j.length-1]);}else if(l=='BLACK_TRIANGLE'){var m=new ArrowHead(ArrowHead.BLACK_TRIANGLE);m.draw(this.canvas,j[j.length-2],j[j.length-1]);}else{}var n=0;var o=0;for(var k=0;k<j.length;k++){n+=j[k].x;o+=j[k].y;}n/=j.length;o/=j.length;var p=0;for(var q=0;q<b.properties.length;q++){var r=null;for(var s=0;s<a.properties.length;s++)if(a.properties[s].meta_id==b.properties[q])r=a.properties[s];if(r!=null)for(var t=0;t<r.children.length;t++){var u=g_model.properties[r.children[t]];if(u.ve.ver_type=='delete')continue;var v=u.value;var w=g_metamodel.metaproperties[r.meta_id];if(w.widget==MetaProperty.FIXED_LIST)for(var x=0;x<w.exfield.length;x++)if(u.value==w.exfield[x].value)v=w.exfield[x].disp;var y=n;var z=o+p*20+10;if(w.position=='src'){y=(h.x*5+i.x)/6;z=(h.y*5+i.y)/6+10;}else if(w.position=='dest'){y=(h.x+i.x*5)/6;z=(h.y+i.y*5)/6+10;}else{y=n;z=o+p*20+10;}this.canvas.drawText({fillStyle:"#000",x:y,y:z,text:v,align:"center",baseline:"middle",font:"16px 'ＭＳ ゴシック'"});p++;}}};DiagramEditor.prototype.getConnectionPoint=function(a,b){if(a.intersectsLine(b.x,b.y,b.x+b.width,b.y))return a.getConnect(new Line2D(b.x,b.y,b.x+b.width,b.y));if(a.intersectsLine(b.x+b.width,b.y,b.x+b.width,b.y+b.height))return a.getConnect(new Line2D(b.x+b.width,b.y,b.x+b.width,b.y+b.height));if(a.intersectsLine(b.x+b.width,b.y+b.height,b.x,b.y+b.height))return a.getConnect(new Line2D(b.x+b.width,b.y+b.height,b.x,b.y+b.height));if(a.intersectsLine(b.x,b.y+b.height,b.x,b.y))return a.getConnect(new Line2D(b.x,b.y+b.height,b.x,b.y));return new Point2D(b.x,b.y);};function EditorTabPanel(){this.editors=[];this.current_editor=null;this.listeners=[];var a=this;this.tabpanel=Ext.create('Ext.tab.Panel',{tabPosition:'top',defaults:{bodyPadding:6,closable:'true'},items:[]});}EditorTabPanel.prototype.close=function(){var a=[];var b=this.editors.length;for(var c=0;c<b;c++)a[c]=this.editors[c].tab;for(var c=0;c<b;c++)a[c].close();};EditorTabPanel.prototype.update=function(){var a=this.editors.length;for(var b=0;b<a;b++)if(this.editors[b].editor.onUpdate)this.editors[b].editor.onUpdate();};EditorTabPanel.prototype.getPanel=function(){return this.tabpanel;};EditorTabPanel.prototype.on=function(a,b){this.listeners.push({event:a,fn:b});};EditorTabPanel.prototype.fireSelectTab=function(){for(var a=0;a<this.listeners.length;a++)this.listeners[a].fn();};EditorTabPanel.prototype.add=function(a,b){var c=this;a.key=b;for(var d=0;d<this.editors.length;d++)if(this.editors[d].editor.key==b){this.tabpanel.setActiveTab(this.editors[d].tab);return;}var e=this.tabpanel.add(a.getPanel());this.editors.push({editor:a,tab:e});e.on('activate',function(){c.current_editor=a;a.onActivate();});e.on('close',function(){for(var a=0;a<c.editors.length;a++)if(c.editors[a].tab==e)c.editors.splice(a,1);});this.tabpanel.setActiveTab(e);a.Initialize();this.current_editor=a;a.onActivate();};function StrLen(a){var b;var c=0;for(b=0;b<a.length;b++){var d=a.charCodeAt(b);if(d>=128)c++;c++;}return c;}function Point2D(a,b){this.x=a;this.y=b;}Point2D.prototype.getX=function(){return this.x;};Point2D.prototype.getY=function(){return this.y;};Point2D.prototype.setLocation=function(a,b){this.x=a;this.y=b;};Point2D.prototype.distanceSq=function(a,b){a-=this.getX();b-=this.getY();return(a*a+b*b);};Point2D.distanceSq=function(a,b){var c=a.x-b.x;var d=a.y-b.y;return(c*c+d*d);};function Line2D(a,b,c,d){this.x1=a;this.y1=b;this.x2=c;this.y2=d;}Line2D.prototype.getX1=function(){return this.x1;};Line2D.prototype.getY1=function(){return this.y1;};Line2D.prototype.getX2=function(){return this.x2;};Line2D.prototype.getY2=function(){return this.y2;};Line2D.prototype.setLine=function(a,b,c,d){this.x1=a;this.y1=b;this.x2=c;this.y2=d;};Line2D.prototype.getP1=function(){return new Point2D(this.x1,this.y1);};Line2D.prototype.getP2=function(){return new Point2D(this.x2,this.y2);};Line2D.prototype.getBounds2D=function(){var a;var b;var c;var d;if(this.x1<this.x2){a=this.x1;c=this.x2-this.x1;}else{a=this.x2;c=this.x1-this.x2;}if(this.y1<this.y2){b=this.y1;d=this.y2-this.y1;}else{b=this.y2;d=this.y1-this.y2;}return new Rectangle2D(a,b,c,d);};Line2D.prototype.getConnect=function(a){var b=(this.getX2()-this.getX1())*(a.getY2()-a.getY1())-(this.getY2()-this.getY1())*(a.getX2()-a.getX1());if(0==b)return null;var c=new Point2D(a.getX1()-this.getX1(),a.getY1()-this.getY1());var d=((a.getY2()-a.getY1())*c.x-(a.getX2()-a.getX1())*c.y)/b;return new Point2D(this.getX1()+d*(this.getX2()-this.getX1()),this.getY1()+d*(this.getY2()-this.getY1()));};Line2D.relativeCCW=function(a,b,c,d,e,f){c-=a;d-=b;e-=a;f-=b;var g=e*d-f*c;if(g==0.0){g=e*c+f*d;if(g>0.0){e-=c;f-=d;g=e*c+f*d;if(g<0.0)g=0.0;}}if(g<0.0)return -1;else if(g>0.0)return 1;else return 0;};Line2D.prototype.relativeCCW=function(a,b){return relativeCCW(this.getX1(),this.getY1(),this.getX2(),this.getY2(),a,b);};Line2D.prototype.relativeCCW=function(a){return relativeCCW(this.getX1(),this.getY1(),this.getX2(),this.getY2(),a.getX(),a.getY());};Line2D.linesIntersect=function(a,b,c,d,e,f,g,h){return((Line2D.relativeCCW(a,b,c,d,e,f)*Line2D.relativeCCW(a,b,c,d,g,h)<=0)&&(Line2D.relativeCCW(e,f,g,h,a,b)*Line2D.relativeCCW(e,f,g,h,c,d)<=0));};Line2D.prototype.intersectsLine=function(a,b,c,d){return Line2D.linesIntersect(a,b,c,d,this.getX1(),this.getY1(),this.getX2(),this.getY2());};Line2D.ptSegDistSq=function(a,b,c,d,e,f){c-=a;d-=b;e-=a;f-=b;var g=e*c+f*d;var h;if(g<=0.0)h=0.0;else{e=c-e;f=d-f;g=e*c+f*d;if(g<=0.0)h=0.0;else h=g*g/(c*c+d*d);}var i=e*e+f*f-h;if(i<0)i=0;return i;};Line2D.ptSegDist=function(a,b,c,d,e,f){return Math.sqrt(Line2D.ptSegDistSq(a,b,c,d,e,f));};Line2D.prototype.ptSegDistSq=function(a,b){return Line2D.ptSegDistSq(this.x1,this.y1,this.x2,this.y2,a,b);};Line2D.prototype.ptSegDist=function(a,b){return Line2D.ptSegDist(this.x1,this.y1,this.x2,this.y2,a,b);};Line2D.ptLineDistSq=function(a,b,c,d,e,f){c-=a;d-=b;e-=a;f-=b;var g=e*c+f*d;var h=g*g/(c*c+d*d);var i=e*e+f*f-h;if(i<0)i=0;return i;};Line2D.ptLineDist=function(a,b,c,d,e,f){return Math.sqrt(ptLineDistSq(a,b,c,d,e,f));};Line2D.prototype.ptLineDistSq=function(a,b){return ptLineDistSq(this.x1,this.y1,this.x2,this.y2,a,b);};Line2D.prototype.ptLineDist=function(a,b){return ptLineDist(this.x1,this.y1,this.x2,this.y2,a,b);};function Rectangle2D(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d;}Rectangle2D.OUT_LEFT=1;Rectangle2D.OUT_TOP=2;Rectangle2D.OUT_RIGHT=4;Rectangle2D.OUT_BOTTOM=8;Rectangle2D.prototype.getX=function(){return this.x;};Rectangle2D.prototype.getY=function(){return this.y;};Rectangle2D.prototype.getWidth=function(){return this.width;};Rectangle2D.prototype.getHeight=function(){return this.height;};Rectangle2D.prototype.contains=function(a,b){var c=this.getX();var d=this.getY();return(a>=c&&b>=d&&a<c+this.getWidth()&&b<d+this.getHeight());};Rectangle2D.contains=function(a,b){return(b.x>=a.x&&b.y>=a.y&&b.x<a.x+a.width&&b.y<a.y+a.height);};function MetaModel(a,b,c){this.id=a;this.name=b;this.metadiagram=1;this.metadiagrams={};this.metaobjects={};this.metarelations={};this.metaproperties={};this.graphics={};this.tools={};}function MetaDiagram(a,b){this.id=metadiagram_IdGenerator.getNewId();this.name='MetaDiagram'+this.id;this.metaobjects=new Array();this.metarelations=new Array();this.instance_name=null;this.properties=new Array();}function MetaObject(a,b){this.classname='MetaObject';this.id=metaobject_IdGenerator.getNewId();this.name='MetaObject'+this.id;this.properties=new Array();this.abstractable=false;this.graphic=null;this.decomposition=null;this.resizable=false;}function MetaRelation(a,b){this.classname='MetaRelation';this.id=metarelation_IdGenerator.getNewId();this.name='MetaRelationship'+this.id;this.properties=new Array();this.bindings=[];this.arrow_type="none";}function Binding(a,b,c){this.src=a;this.dest=b;this.parent=c;}function MetaProperty(a,b){this.id=metaproperty_IdGenerator.getNewId();this.name='MetaProperty'+this.id;this.data_type="String";this.widget="input field";this.exfield="";}MetaProperty.STRING="string";MetaProperty.NUMBER="number";MetaProperty.COLLECTION="collection";MetaProperty.COLLECTION_STRING="collection_String";MetaProperty.INPUT_FIELD="input field";MetaProperty.FIXED_LIST="fixed list";function GraphicInfo(a,b){this.type=a;this.option=b;this.src=null;}GraphicInfo.TYPE_LINES='lines';GraphicInfo.TYPE_POLYGON='polygon';GraphicInfo.TYPE_SRC='src';function ToolMapping(){this.id=null;this.parent=null;this.metaobject_id=null;this.icon_type=null;this.icon=null;}function Model(){this.id=1;this.root=1;this.current_version=1;this.diagrams={};this.objects={};this.properties={};this.relationships={};}function Diagram(a){this.user_id=g_userinfo.id;this.id=diagram_IdGenerator.getNewId()+g_projectinfo.id*10000;this.project_id=g_projectinfo.id;this.meta_id=a;this.properties=new Array();this.objects=new Array();this.relationships=new Array();this.ve=new VersionElement();}function Object(a){this.meta_id=a;this.user_id=g_userinfo.id;this.id=object_IdGenerator.getNewId()+g_projectinfo.id*10000;this.project_id=g_projectinfo.id;this.bound=new Rectangle2D(50,50,50,50);this.properties=new Array();this.ve=new VersionElement();this.diagram=null;this.ofd=new ObjectForDiagram();}function ObjectForDiagram(){this.z=0;}function Relationship(a){this.meta_id=a;this.user_id=g_userinfo.id;this.id=object_IdGenerator.getNewId()+g_projectinfo.id*10000;this.project_id=g_projectinfo.id;this.src=null;this.dest=null;this.points=new Array();this.properties=new Array();this.ve=new VersionElement();this.rfd=new RelationshipForDiagram();}function RelationshipForDiagram(){this.z=0;}function PropertyList(){this.meta_id=null;this.children=new Array();}function Property(){this.user_id=g_userinfo.id;this.id=property_IdGenerator.getNewId()+g_projectinfo.id*10000;this.project_id=g_projectinfo.id;this.meta_id=null;this.value='';this.ve=new VersionElement();}function VersionElement(){this.version=1;this.ver_type="add";this.a=0;}VersionElement.update=function(a){if(a.ver_type!='add')a.ver_type='update';};function MetaModelController(){}MetaModelController.getMetaObject=function(a,b){return g_metamodel.metaobjects[b];};MetaModelController.getMetaRelation=function(a,b){return g_metamodel.metarelations[b];};function IdGenerator(){this.idcount=0;}IdGenerator.prototype.setOffset=function(a){if(this.idcount<a)this.idcount=a;};IdGenerator.prototype.getNewId=function(){this.idcount++;return this.idcount;};var diagram_IdGenerator=new IdGenerator();var object_IdGenerator=new IdGenerator();var property_IdGenerator=new IdGenerator();function SequenceEditor(a,b,c){this.name=a;this.key=b;this.diagram=c;this.diagramController=new DiagramController(this.diagram);this.tool=null;this.drag_start=new Point2D();this.drag_move=new Point2D();this.drag_end=new Point2D();this.selected=null;this.dragMode=0;this.select_button=null;var d=this;this.diagramController.on('updateProperty',function(a,b,c){if(c.bound!=undefined)calObjHeight(c);d.draw();});this.width=1000;this.height=1000;this.panel={id:this.key,title:a,autoScroll:true,html:'<canvas id="canvas_'+this.key+'" width='+this.width+' height='+this.height+'></canvas>',closable:'true'};this.canvas=$('#canvas_'+this.key);}SequenceEditor.prototype.draw=function(){var a=this;if(a.canvas==null)a.canvas=$('#canvas_'+a.key);a.canvas.drawRect({fillStyle:"#fff",x:0,y:0,width:a.width,height:a.height,fromCenter:false});for(var b=0;b<a.diagram.objects.length;b++){var c=a.diagram.objects[b];var d=g_model.objects[c];if(d.ve.ver_type=='delete')continue;var e='#000';if(d==a.selected)e='#00f';var f=g_metamodel.metaobjects[d.meta_id];if(f.graphic==null||f.graphic=='rect')a.canvas.drawRect({strokeStyle:e,strokeWidth:1,x:d.bound.x,y:d.bound.y,width:d.bound.width,height:d.bound.height,fromCenter:false});else if(f.graphic=='rounded')a.canvas.drawRect({strokeStyle:e,strokeWidth:2,x:d.bound.x,y:d.bound.y,width:d.bound.width,height:d.bound.height,fromCenter:false,cornerRadius:5});else if(f.graphic=='circle')$("canvas").drawArc({strokeStyle:e,strokeWidth:2,x:d.bound.x+d.bound.width/2,y:d.bound.y+d.bound.width/2,radius:d.bound.width/2,start:0,end:359,fromCenter:true});else{var g=g_metamodel.graphics[f.graphic];g.option.col=e;if(g.type=='polygon'){a.canvas.translateCanvas({x:d.bound.x+d.bound.width/2,y:d.bound.y+d.bound.height/2});a.canvas.scaleCanvas({x:0,y:0,scaleX:d.bound.width/50,scaleY:d.bound.height/50});a.canvas.drawPolygon(g.option);a.canvas.restoreCanvas();a.canvas.restoreCanvas();}else if(g.type=='lines')a.canvas.translateCanvas({x:d.bound.x+d.bound.width/2,y:d.bound.y+d.bound.width/2}).drawLine(g.option).restoreCanvas();}if(f.resizable==true&&d==a.selected)a.canvas.drawRect({fillStyle:"#00f",strokeWidth:2,x:d.bound.x+d.bound.width-12,y:d.bound.y+d.bound.height-12,width:12,height:12,fromCenter:false});var h=0;for(var i=0;i<f.properties.length;i++){var j=null;for(var k=0;k<d.properties.length;k++)if(d.properties[k].meta_id==f.properties[i])j=d.properties[k];if(j!=null){for(var l=0;l<j.children.length;l++){var m=g_model.properties[j.children[l]];if(m.ve.ver_type=='delete')continue;var n=m.value;var o=g_metamodel.metaproperties[j.meta_id];if(o.widget==MetaProperty.FIXED_LIST)for(var p=0;p<o.exfield.length;p++)if(m.value==o.exfield[p].value)n=o.exfield[p].disp;a.canvas.drawText({fillStyle:"#000",x:d.bound.x+d.bound.width/2,y:d.bound.y+h*20+20,text:n,align:"center",baseline:"middle",font:"16px 'ＭＳ ゴシック'"});h++;}if(f.properties.length-1!=i)a.canvas.drawLine({strokeStyle:"#000",strokeWidth:2,x1:d.bound.x,y1:d.bound.y+h*20+10,x2:d.bound.x+d.bound.width,y2:d.bound.y+h*20+10});}}}for(var b=0;b<a.diagram.relationships.length;b++){var q=a.diagram.relationships[b];var r=g_model.relationships[q];if(r.ve.ver_type=='delete')continue;a.draw_relationship(r);}if(a.tool!=null)a.canvas.drawText({fillStyle:"#000",x:a.drag_move.x,y:a.drag_move.y,text:a.tool.name,align:"center",baseline:"middle",font:"16px 'ＭＳ ゴシック'"});if(a.dragMode==SequenceEditor.DRAG_RUBBERBAND)a.canvas.drawLine({strokeStyle:"#777",strokeWidth:2,strokeCap:"round",strokeJoin:"miter",x1:a.drag_start.x,y1:a.drag_start.y,x2:a.drag_move.x,y2:a.drag_move.y});};SequenceEditor.prototype.getPanel=function(){return this.panel;};SequenceEditor.prototype.Initialize=function(){var a=this;this.canvas=$('#canvas_'+this.key);var b=new Ext.menu.Menu({items:[{id:'delete_element',text:'削除'},{id:'delete_point',text:'ポイントを削除'},{id:'up_step',text:'一つ上へ'},{id:'down_step',text:'一つ下へ'},{id:'info',text:'情報'}],listeners:{itemclick:function(b){switch(b.id){case 'delete_element':a.deleteSelected();break;case 'delete_point':a.deletePoint();break;}},click:function(b,c){switch(c.id){case 'delete_element':a.deleteSelected();break;case 'delete_point':a.deletePoint();break;case 'up_step':a.up_step();break;case 'down_step':a.down_step();break;case 'info':a.info();break;}}}});if(navigator.userAgent.indexOf('iPad')>0){this.canvas.touchmove(function(b){var c=b.target.getBoundingClientRect();mouseX=b.clientX-c.left;mouseY=b.clientY-c.top;a.ActionMove(mouseX,mouseY);});this.canvas.touchstart(function(c){var d=c.target.getBoundingClientRect();mouseX=c.clientX-d.left;mouseY=c.clientY-d.top;if(c.button==2)b.showAt(c.clientX,c.clientY);else{a.ActionDown(mouseX,mouseY);a.draw();}});this.canvas.touchend(function(b){var c=b.target.getBoundingClientRect();mouseX=b.clientX-c.left;mouseY=b.clientY-c.top;a.ActionUp(mouseX,mouseY);a.draw();});}else{this.canvas.mousemove(function(b){var c=b.target.getBoundingClientRect();mouseX=b.clientX-c.left;mouseY=b.clientY-c.top;a.ActionMove(mouseX,mouseY);});this.canvas.mousedown(function(c){var d=c.target.getBoundingClientRect();mouseX=c.clientX-d.left;mouseY=c.clientY-d.top;if(c.button==2)b.showAt(c.clientX,c.clientY);else{a.ActionDown(mouseX,mouseY);a.draw();}});this.canvas.mouseup(function(b){var c=b.target.getBoundingClientRect();mouseX=b.clientX-c.left;mouseY=b.clientY-c.top;a.ActionUp(mouseX,mouseY);a.draw();});}this.draw();};SequenceEditor.prototype.onActivate=function(){this.createButton();current_editor=this;};SequenceEditor.DRAG_NONE=0;SequenceEditor.DRAG_RUBBERBAND=1;SequenceEditor.DRAG_MOVE=2;SequenceEditor.DRAG_POINT=3;SequenceEditor.DRAG_RANGE=4;SequenceEditor.DRAG_RESIZE=5;SequenceEditor.prototype.ActionMove=function(a,b){this.drag_move.x=a;this.drag_move.y=b;if(this.dragMode==SequenceEditor.DRAG_MOVE){if(this.selected!=null){this.updateObject(this.selected,Number(a-10),Number(b-10));this.draw();}}else if(this.dragMode==SequenceEditor.DRAG_RUBBERBAND)this.draw();else if(this.dragMode==SequenceEditor.DRAG_RESIZE){this.selected.bound.width=this.drag_move.x-this.selected.bound.x;this.selected.bound.height=this.drag_move.y-this.selected.bound.y;if(this.selected.bound.width<16)this.selected.bound.width=16;if(this.selected.bound.height<16)this.selected.bound.height=16;this.draw();}else{}};SequenceEditor.prototype.updateObject=function(a,b,c){var d=g_metamodel.metaobjects[a.meta_id];if(d.seq){a.bound.x=b-10;a.bound.y=100;}else{a.bound.x=b-10;a.bound.y=c-10;}VersionElement.update(a.ve);};SequenceEditor.prototype.ActionDown=function(a,b){if(this.tool==null)if(this.clicknode(Number(a),Number(b))){if(this.dragMode!=SequenceEditor.DRAG_RESIZE)this.dragMode=SequenceEditor.DRAG_MOVE;}else if(this.clickedge(a,b)){}else{this.dragMode=SequenceEditor.DRAG_NONE;this.selected=null;}else if(this.tool.classname=='MetaObject'){var c=this.diagramController.addObject(a,b,this.tool.id);var d=g_metamodel.metaobjects[c.meta_id];if(d.seq){c.bound.width=16;c.bound.height=300;}this.select_button.toggle(true,false);}else if(this.tool.classname=='MetaRelation')this.dragMode=SequenceEditor.DRAG_RUBBERBAND;this.drag_start.x=a;this.drag_start.y=b;};SequenceEditor.prototype.ActionUp=function(a,b){this.drag_end.x=a;this.drag_end.y=b;if(this.dragMode==SequenceEditor.DRAG_RUBBERBAND){var c=this.diagramController.addRelationship(this.drag_start,this.drag_end,this.tool.id);g_model.properties[c.properties[0].children[0]].value=''+Math.floor(this.drag_start.y-200);this.select_button.toggle(true);}else if(this.dragMode==SequenceEditor.DRAG_POINT)this.movePoint(this.selected,this.drag_start,this.drag_end);this.dragMode=SequenceEditor.DRAG_NONE;};SequenceEditor.prototype.deletePoint=function(){var a=this.selected;if(a==null)return;a.points.length=0;};SequenceEditor.prototype.movePoint=function(a,b,c){if(a!=null){var d=c.y-b.y;var e=null;for(var f=0;f<a.properties.length;f++)if(a.properties[f].meta_id==4)e=a.properties[f];var g=g_model.objects[a.src].bound.height;if((Math.floor(g_model.properties[e.children[0]].value)+Math.floor(d))>-100&&(Math.floor(g_model.properties[e.children[0]].value)+Math.floor(d))<g-100)g_model.properties[e.children[0]].value=''+(Math.floor(g_model.properties[e.children[0]].value)+Math.floor(d));}};SequenceEditor.prototype.clicknode=function(a,b){var c=this.diagramController.findNode(new Point2D(a,b));if(c!=null){if(c==this.selected)if(Rectangle2D.contains(new Rectangle2D(c.bound.x+c.bound.width-12,c.bound.y+c.bound.height-12,12,12),new Point2D(a,b)))this.dragMode=SequenceEditor.DRAG_RESIZE;if(c.ve.ver_type=="delete")return false;this.selected=c;this.fireSelectObject(this.selected);return true;}return false;};SequenceEditor.prototype.clickedge=function(a,b){for(var c=0;c<this.diagram.relationships.length;c++)if(this.click_a_edge(g_model.relationships[this.diagram.relationships[c]],a,b))return true;return false;};SequenceEditor.prototype.click_a_edge=function(a,b,c){if(a.ve.ver_type=="delete")return false;var d=new Array();var e=ModelController.getObject(this.diagram,a.src);var f=ModelController.getObject(this.diagram,a.dest);var g=new Point2D((e.bound.x+e.bound.width/2),(e.bound.y+e.bound.height/2));var h=new Point2D((f.bound.x+f.bound.width/2),(f.bound.y+f.bound.height/2));var i=null;for(var j=0;j<a.properties.length;j++)if(a.properties[j].meta_id==4)i=a.properties[j];g.y=Number(g_model.properties[i.children[0]].value)+200;h.y=g.y;d.push(g);d=d.concat(a.points);d.push(h);for(var j=0;j<d.length-1;j++)if(new Line2D(d[j].x,d[j].y,d[j+1].x,d[j+1].y).ptSegDist(b,c)<16){if(a==this.selected)this.dragMode=SequenceEditor.DRAG_POINT;this.selected=a;this.fireSelectRelationship(this.selected);return true;}return false;};SequenceEditor.prototype.createButton=function(){var a=this;var b=Ext.getCmp('toolpanel');b.removeAll();var c=[];this.metadiagram=g_metamodel.metadiagrams[this.diagram.meta_id];for(var d=0;d<this.metadiagram.metaobjects.length;d++)c.push(g_metamodel.metaobjects[this.metadiagram.metaobjects[d]]);for(var d=0;d<this.metadiagram.metarelations.length;d++)c.push(g_metamodel.metarelations[this.metadiagram.metarelations[d]]);c.unshift(null);for(var d=0;d<c.length;d++){var e='';if(c[d]==null)e='select';else e=c[d].name;var f=Ext.create('Ext.Button',{text:e,width:100,height:32,enableToggle:true,toggleGroup:'tools',listeners:{click:function(){},toggle:function(b,d){if(d){var e=c[this.index];a.tool=e;}},mouseover:function(){}}});if(f.text=='select')this.select_button=f;f.index=d;b.add(f);}};SequenceEditor.prototype.deleteSelected=function(){if(this.selected!=null){for(var a=0;a<this.diagram.objects.length;a++)if(this.diagram.objects[a]==this.selected.id)this.diagramController.deleteObject(this.selected.id);for(var a=0;a<this.diagram.relationships.length;a++)if(this.diagram.relationships[a]==this.selected.id)this.diagramController.deleteRelationship(this.selected.id);this.draw();}};SequenceEditor.prototype.info=function(){if(this.selected!=null){var a='ver_type='+this.selected.ve.ver_type;a+='<br>version='+this.selected.ve.version;a+='<br>id='+this.selected.id;a+='<br>pid='+Math.floor(this.selected.id/10000);if(this.selected.ofd!=undefined)a+='<br>z='+this.selected.ofd.z;console.log(a);Ext.getCmp('element-infomation').removeAll();Ext.getCmp('element-infomation').add({html:a});}};SequenceEditor.prototype.up_step=function(){if(this.selected.ofd!=undefined){for(var a=0;a<this.diagram.objects.length;a++){var b=this.diagram.objects[a];var c=g_model.objects[b];if(c.ofd.z==this.selected.ofd.z+1)c.ofd.z--;}if(this.selected!=null)this.selected.ofd.z++;}else if(this.selected.rfd!=undefined){for(var a=0;a<this.diagram.relationships.length;a++){var d=this.diagram.relationships[a];var e=g_model.relationships[d];if(e.rfd.z==this.selected.rfd.z+1)e.rfd.z--;}if(this.selected!=null)this.selected.rfd.z++;}};SequenceEditor.prototype.down_step=function(){if(this.selected.ofd!=undefined){for(var a=0;a<this.diagram.objects.length;a++){var b=this.diagram.objects[a];var c=g_model.objects[b];if(c.ofd.z==this.selected.ofd.z-1)c.ofd.z++;}if(this.selected!=null){this.selected.ofd.z--;console.log('down');}}else if(this.selected.rfd!=undefined){for(var a=0;a<this.diagram.relationships.length;a++){var d=this.diagram.relationships[a];var e=g_model.relationships[d];if(e.rfd.z==this.selected.rfd.z-1)e.rfd.z++;}if(this.selected!=null)this.selected.rfd.z--;}};SequenceEditor.prototype.fireSelectObject=function(a){var b=MetaModelController.getMetaObject(g_metamodel.metadiagram,a.meta_id);this.createPropertyPanel(b,a);this.info();};SequenceEditor.prototype.fireSelectRelationship=function(a){var b=MetaModelController.getMetaRelation(g_metamodel.metadiagram,a.meta_id);this.createPropertyPanel(b,a);this.info();};SequenceEditor.prototype.createPropertyPanel=function(a,b){var c=null;if(arguments.length==3)c=arguments[2];var d=this;Ext.getCmp('propertypanel').removeAll();var e=Ext.create('Ext.tab.Panel',{items:[]});for(var f=0;f<a.properties.length;f++){var g=g_metamodel.metaproperties[a.properties[f]];var h=null;for(var i=0;i<b.properties.length;i++)if(b.properties[i].meta_id==a.properties[f])h=b.properties[i];if(h==null){plist=new PropertyList();plist.meta_id=g.id;if(g.data_type!=MetaProperty.COLLECTION_STRING)this.diagramController.addProperty(plist,g);b.properties.push(plist);h=plist;}var j=null;if(g.data_type==MetaProperty.COLLECTION_STRING)j=PropertyPanel.CollectionString(this,g,h,b,a);else if(g.widget==MetaProperty.INPUT_FIELD)j=PropertyPanel.InputField(this,g,h,b);else if(g.widget==MetaProperty.FIXED_LIST)j=PropertyPanel.FixedList(this,g,h,b);j.index=f;e.add(j);if(g.id==c)e.setActiveTab(j);}if(a.decomposition!=undefined)e.add(PropertyPanel.Decomposition(this,a,b));Ext.getCmp('propertypanel').add(e);};SequenceEditor.prototype.getImage=function(a){window.open(this.canvas.getCanvasImage(a));};SequenceEditor.prototype.draw_sequence_specific=function(){for(var a=0;a<this.diagram.relationships.length;a++){var b=this.diagram.relationships[a];var c=g_model.relationships[b];for(var d=0;d<this.diagram.relationships.length;d++){var e=this.diagram.relationships[a];var f=g_model.relationships[e];if(c.src==f.dest&&c.dest==f.src){}}}for(var a=0;a<this.diagram.objects.length;a++){var g=this.diagram.objects[a];var h=[];for(var d=0;d<this.diagram.relationships.length;d++){var c=g_model.relationships[this.diagram.relationships[a]];if(c.dest==g)h.push(c);}h.sort(function(a,b){return g_model.properties[a.properties[0].children[0]].value>g_model.properties[b.properties[0].children[0]].value;});for(var d=0;d<h.length;d++)h[d];}};SequenceEditor.prototype.draw_relationship=function(a){var b='#000';if(a==this.selected)b='#00f';if(a.ve.ver_type=='delete')return;var c=ModelController.getObject(this.diagram,a.src);var d=ModelController.getObject(this.diagram,a.dest);var e=new Point2D((c.bound.x+c.bound.width/2),(c.bound.y+c.bound.height/2));var f=new Point2D((d.bound.x+d.bound.width/2),(d.bound.y+d.bound.height/2));var g=null;for(var h=0;h<a.properties.length;h++)if(a.properties[h].meta_id==4)g=a.properties[h];e.y=Number(g_model.properties[g.children[0]].value)+200;f.y=e.y;var i=0;var j=0;i=this.getConnectionPoint(new Line2D(e.x,e.y,f.x,f.y),c.bound);j=this.getConnectionPoint(new Line2D(f.x,f.y,e.x,e.y),d.bound);var k=[];k.push(i);k.push(j);for(var h=0;h<k.length-1;h++)this.canvas.drawLine({strokeStyle:b,strokeWidth:2,strokeCap:"round",strokeJoin:"miter",x1:k[h].x,y1:k[h].y,x2:k[h+1].x,y2:k[h+1].y});var l=g_metamodel.metarelations[a.meta_id];var m=l.arrow_type;if(m=='v'){var n=new ArrowHead(ArrowHead.V);n.draw(this.canvas,k[k.length-2],k[k.length-1]);}else if(m=='TRIANGLE'){var n=new ArrowHead(ArrowHead.TRIANGLE);n.draw(this.canvas,k[k.length-2],k[k.length-1]);}else if(m=='BLACK_TRIANGLE'){var n=new ArrowHead(ArrowHead.BLACK_TRIANGLE);n.draw(this.canvas,k[k.length-2],k[k.length-1]);}else{}var o=0;var p=0;for(var h=0;h<k.length;h++){o+=k[h].x;p+=k[h].y;}o/=k.length;p/=k.length;var q=0;for(var r=0;r<l.properties.length;r++){var g=null;for(var s=0;s<a.properties.length;s++)if(a.properties[s].meta_id==l.properties[r])g=a.properties[s];if(g!=null)for(var t=0;t<g.children.length;t++){var u=g_model.properties[g.children[t]];if(u.ve.ver_type=='delete')continue;var v=u.value;var w=g_metamodel.metaproperties[g.meta_id];if(w.visible==false)continue;if(w.widget==MetaProperty.FIXED_LIST)for(var x=0;x<w.exfield.length;x++)if(u.value==w.exfield[x].value)v=w.exfield[x].disp;this.canvas.drawText({fillStyle:"#000",x:o,y:p+q*20+10,text:v,align:"center",baseline:"middle",font:"16px 'ＭＳ ゴシック'"});q++;}}};SequenceEditor.prototype.getConnectionPoint=function(a,b){if(a.intersectsLine(b.x,b.y,b.x+b.width,b.y))return a.getConnect(new Line2D(b.x,b.y,b.x+b.width,b.y));if(a.intersectsLine(b.x+b.width,b.y,b.x+b.width,b.y+b.height))return a.getConnect(new Line2D(b.x+b.width,b.y,b.x+b.width,b.y+b.height));if(a.intersectsLine(b.x+b.width,b.y+b.height,b.x,b.y+b.height))return a.getConnect(new Line2D(b.x+b.width,b.y+b.height,b.x,b.y+b.height));if(a.intersectsLine(b.x,b.y+b.height,b.x,b.y))return a.getConnect(new Line2D(b.x,b.y+b.height,b.x,b.y));return new Point2D(b.x,b.y);};