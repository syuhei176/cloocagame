/* Copyright (C) 2012 Technical Rockstars Co.,Ltd. All Rights Reserved. */function saveMetaModel(a,b){var c=JSON.stringify(g_metamodel);$.post('/wb/save',{id:a,xml:c},b,"json");}function saveAll(a){var b=JSON.stringify(g_metamodel);$.post('/metamodel-save',{id:g_metaproject.id,name:g_metaproject.name,visibillity:g_metaproject.visibillity,xml:b,welcome_message:g_metaproject.welcome_message},a,"json");}function wb_loadMetaModel(a){Ext.MessageBox.show({title:'Please wait',msg:'Loading...',progressText:'Initializing...',width:300,progress:true,closable:false,animEl:'mb6'});g_metaproject=g_toolinfo;Ext.getCmp('tool-name').setText('プロジェクト名：'+g_metaproject.name);console.log('loaded json string = '+g_metaproject.xml);if(g_metaproject.xml==' '||g_metaproject.xml==null||g_metaproject.xml.length==0)g_metamodel=new MetaModel(g_metaproject.id,g_metaproject.name);else g_metamodel=JSON.parse(g_metaproject.xml);if(g_metaproject.config==' '||g_metaproject.config==null||g_metaproject.config==0)g_wbconfig={targets:[]};else g_wbconfig=JSON.parse(g_metaproject.config);metadiagram_IdGenerator=new IdGenerator();metaobject_IdGenerator=new IdGenerator();metarelation_IdGenerator=new IdGenerator();metaproperty_IdGenerator=new IdGenerator();for(var b in g_metamodel.metadiagrams)if(g_metamodel.metadiagrams[b]!=null)metadiagram_IdGenerator.setOffset(g_metamodel.metadiagrams[b].id);for(var b in g_metamodel.metaobjects)if(g_metamodel.metaobjects[b]!=null)metaobject_IdGenerator.setOffset(g_metamodel.metaobjects[b].id);for(var b in g_metamodel.metarelations)if(g_metamodel.metarelations[b]!=null)metarelation_IdGenerator.setOffset(g_metamodel.metarelations[b].id);for(var b in g_metamodel.metaproperties)if(g_metamodel.metaproperties[b]!=null)metaproperty_IdGenerator.setOffset(g_metamodel.metaproperties[b].id);load_templates();Ext.MessageBox.hide();}function check_metamodel(){var a=true;a=false;for(a in g_metamodel.metadiagrams)if(g_metamodel.metadiagram==g_metamodel.metadiagrams[a].id)a=true;if(a){}else return false;return true;}MetaJSONEditor.prototype.createGridEditor=function(a,b,c,d){var e=this;var f=[];for(var g in a)f.push(a[g]);Ext.create('Ext.data.Store',{storeId:'simpsonsStore',fields:['id','name'],data:{'items':f},proxy:{type:'memory',reader:{type:'json',root:'items'}}});var h=Ext.create('Ext.grid.Panel',{title:b,store:Ext.data.StoreManager.lookup('simpsonsStore'),columns:[{header:'ID',dataIndex:'id'},{header:'名前',dataIndex:'name',flex:1}],height:200,width:400,listeners:{itemdblclick:{fn:function(b,d,e,f,g){c(a[d.data.id]);}}},tbar:[{text:'追加',iconCls:'add',handler:function(b){var c=d();a[c.id]=c;var f={id:c.id,name:c.name};h.getStore().insert(c.id,f);e.jsoneditor.setValue(JSON.stringify(g_metamodel));}},{text:'削除',iconCls:'delete',handler:function(b){var c=h.getSelectionModel().getSelection()[0];if(c){h.getStore().remove(c);delete a[c.get('id')];e.jsoneditor.setValue(JSON.stringify(g_metamodel));}}}]});var i=Ext.create('Ext.panel.Panel',{xtype:'panel',title:b,layout:{type:'hbox',align:'center'},items:[h]});return i;};function MetaDiagramsEditor(a){var b=this;var c=[];for(var d=0;d<a.length;d++)if(a[d]!=null)c.push(a[d]);Ext.create('Ext.data.Store',{storeId:'simpsonsStore',fields:['id','name'],data:{'items':c},proxy:{type:'memory',reader:{type:'json',root:'items'}}});var e=Ext.create('Ext.grid.Panel',{title:'MetaDiagrams',store:Ext.data.StoreManager.lookup('simpsonsStore'),columns:[{header:'Id',dataIndex:'id'},{header:'Name',dataIndex:'name',flex:1}],height:200,width:400,listeners:{itemdblclick:{fn:function(c,d,f,g,h){b.show_setting_metadiagram_window(a[d.data.id],function(a){alert(g);e.getStore().getAt(g).set('name',a.name);});}}},tbar:[{text:'追加',iconCls:'add',handler:function(b){var c=new MetaDiagram(a.length,'');a.push(c);var d={id:c.id,name:c.name};e.getStore().insert(c.id,d);}},{text:'削除',iconCls:'delete',handler:function(a){var b=e.getSelectionModel().getSelection()[0];if(b)e.getStore().remove(b);}}]});this.panel=Ext.create('Ext.panel.Panel',{xtype:'panel',title:'MetaDiagrams',layout:{type:'hbox',align:'center'},items:[e],closable:'true'});}function show_setting_metadiagram_window(a,b){var c=this;var d=Ext.create('Ext.data.Store',{fields:['disp','type'],data:[{"disp":"テンプレート","type":"template"},{"disp":"テンプレート（ダイアグラム）","type":"template_diagram"},{"disp":"コピー","type":"copy"}]});var e=[];for(var f=0;f<a.metaobjects.length;f++)e.push(g_metamodel.metaobjects[a.metaobjects[f]].name);var g=[];for(var f=0;f<a.metarelations.length;f++)g.push(g_metamodel.metarelations[a.metarelations[f]].name);var h=Ext.create('Ext.window.Window',{title:'metadiagram',height:240,width:360,layout:'vbox',items:[{xtype:'textfield',fieldLabel:'name',value:a.name,listeners:{scope:this,'change':function(b,c,d,e){a.name=c;}}},{xtype:'displayfield',fieldLabel:'MetaObjects',name:'metaobjects',value:e},{xtype:'button',text:'add metaobjects',handler:function(){c.createMetaObjectGrid(function(b){a.metaobjects=b;h.hide();show_setting_metadiagram_window(a);},a.metaobjects);}},{xtype:'displayfield',fieldLabel:'MetaRelationships',name:'metarelations',value:g},{xtype:'button',text:'add metarelationships',handler:function(){c.createMetaRelationGrid(function(b){a.metarelations=b;},a.metarelations);}},{xtype:'button',text:'OK',handler:function(){h.hide();if(b!=null)b(a);}}]});h.show();}MetaDiagramsEditor.prototype.save=function(){var a=this;saveMetaModel(g_metaproject.id,function(b){if(b)a.panel.setTitle('MetaDiagrams');});};MetaDiagramsEditor.prototype.getPanel=function(){return this.panel;};MetaDiagramsEditor.prototype.Initialize=function(){};MetaDiagramsEditor.prototype.onActivate=function(){current_editor=this;};function createMetaObjectGrid(a,b){var c=[];for(var d=0;d<g_metamodel.metaobjects.length;d++)if(g_metamodel.metaobjects[d]!=null)c.push(g_metamodel.metaobjects[d]);createMetaElementGrid(c,a,b);}function createMetaRelationGrid(a,b){var c=[];for(var d=0;d<g_metamodel.metarelations.length;d++)if(g_metamodel.metarelations[d]!=null)c.push(g_metamodel.metarelations[d]);createMetaElementGrid(c,a,b);}function createMetaElementGrid(a,b,c){var d=null;var e=[];Ext.create('Ext.data.Store',{storeId:'metaobjects',fields:['id','name'],data:{'items':a},proxy:{type:'memory',reader:{type:'json',root:'items'}}});var f=Ext.create('Ext.grid.Panel',{title:'MetaObjects',autoScroll:true,store:Ext.data.StoreManager.lookup('metaobjects'),columns:[{header:'Id',dataIndex:'id'},{header:'Name',dataIndex:'name',flex:1}],height:240,width:400,selModel:new Ext.selection.CheckboxModel({listeners:{selectionchange:function(a,b){e=[];for(var c=0;c<b.length;c++){console.log(b[c].get('id'));e.push(b[c].get('id'));}}}})});d=Ext.create('Ext.window.Window',{title:'mappings',width:360,height:300,layout:'fit',items:[f],dockedItems:[{xtype:'toolbar',dock:'bottom',ui:'footer',layout:{pack:'center'},items:[]},{xtype:'toolbar',items:[{text:'OK',tooltip:'OK',iconCls:'add',handler:function(){b(e);d.hide();}}]}]});d.show();for(var g=0;g<c.length;g++)f.getSelectionModel().select(c[g]-1,true);}function MetaJSONEditor(a){this.resource=g_metamodel;var b=this;this.jsoneditor=Ext.create('Ext.form.field.TextArea',{title:'json',autoScroll:true,width:Ext.getCmp('centerpanel').getWidth(),height:Ext.getCmp('centerpanel').getHeight(),value:JSON.stringify(g_metamodel),listeners:{change:{fn:function(a,c,d,e){g_metamodel=JSON.parse(c);b.editor.setTitle('メタモデル*');}}}});this.deditor=this.createGridEditor(g_metamodel.metadiagrams,'MetaDiagram',function(a){b.createJsonWindow(g_metamodel.metadiagrams[a.id],function(c,d,e,f){g_metamodel.metadiagrams[a.id]=JSON.parse(d);b.jsoneditor.setValue(JSON.stringify(g_metamodel));});},function(){var a=new MetaDiagram();g_metamodel.metadiagrams[a.id]=a;return a;});this.oeditor=this.createGridEditor(g_metamodel.metaobjects,'MetaObjects',function(a){console.log(a.id);b.createJsonWindow(g_metamodel.metaobjects[a.id],function(c,d,e,f){g_metamodel.metaobjects[a.id]=JSON.parse(d);b.jsoneditor.setValue(JSON.stringify(g_metamodel));});},function(){var a=new MetaObject();g_metamodel.metaobjects[a.id]=a;return a;});this.reditor=this.createGridEditor(g_metamodel.metarelations,'MetaRelationships',function(a){console.log(a.id);b.createJsonWindow(g_metamodel.metarelations[a.id],function(c,d,e,f){g_metamodel.metarelations[a.id]=JSON.parse(d);b.jsoneditor.setValue(JSON.stringify(g_metamodel));});},function(){var a=new MetaRelation();g_metamodel.metarelations[a.id]=a;return a;});this.peditor=this.createGridEditor(g_metamodel.metaproperties,'MetaProperties',function(a){console.log(a.id);b.createJsonWindow(g_metamodel.metaproperties[a.id],function(c,d,e,f){g_metamodel.metaproperties[a.id]=JSON.parse(d);b.jsoneditor.setValue(JSON.stringify(g_metamodel));});},function(){var a=new MetaProperty();g_metamodel.metaproperties[a.id]=a;return a;});var c=Ext.create('Ext.tab.Panel',{title:'メタモデル',tabPosition:'bottom',defaults:{bodyPadding:6},items:[this.deditor,this.oeditor,this.reditor,this.peditor,this.jsoneditor],closable:'true'});this.editor=c;}MetaJSONEditor.prototype.save=function(){var a=this;saveMetaModel(g_metaproject.id,function(b){if(b)a.editor.setTitle('JSONEditor');});};MetaJSONEditor.prototype.getPanel=function(){return this.editor;};MetaJSONEditor.prototype.Initialize=function(){};MetaJSONEditor.prototype.onActivate=function(){current_editor=this;};MetaJSONEditor.prototype.createJsonWindow=function(a,b){var c=this;var d=Ext.create('Ext.form.field.TextArea',{title:'json',autoScroll:true,width:480,height:240,value:JSON.stringify(a),listeners:{change:{fn:b}}});var e=Ext.create('Ext.window.Window',{title:'json',width:480,height:240,layout:'fit',items:[d]});e.show();};function TempConfigEditor(){var a=this;Ext.create('Ext.data.Store',{storeId:'targets',fields:['name','downloadable','runnable','deploy','mapping'],data:{'items':g_wbconfig.targets},proxy:{type:'memory',reader:{type:'json',root:'items'}}});var b=Ext.create('Ext.grid.Panel',{title:'targets',store:Ext.data.StoreManager.lookup('targets'),columns:[{header:'Name',dataIndex:'name',flex:1},{header:'download',dataIndex:'downloadable',flex:1},{header:'run',dataIndex:'runnable',flex:1},{header:'deploy',dataIndex:'deploy',flex:1}],width:Ext.getCmp('centerpanel').getWidth()-50,height:Ext.getCmp('centerpanel').getHeight()-200,listeners:{itemdblclick:{fn:function(b,c,d,e,f,g){a.show_setting_mappings_window(g_wbconfig.targets[e]);}}}});if(g_wbconfig.editor==undefined)g_wbconfig.editor={};var c=Ext.create('Ext.panel.Panel',{title:'grid',width:Ext.getCmp('centerpanel').getWidth()-50,height:Ext.getCmp('centerpanel').getHeight()-50,layout:{type:'vbox',align:'center'},items:[b,{xtype:'checkbox',fieldLabel:'generate',checked:g_wbconfig.editor.generatable,listeners:{scope:this,'change':function(b,c,d,e){g_wbconfig.editor.generatable=c;a.texteditor.setValue(JSON.stringify(g_wbconfig));}}},{xtype:'checkbox',fieldLabel:'download',checked:g_wbconfig.editor.downloadable,listeners:{scope:this,'change':function(b,c,d,e){g_wbconfig.editor.downloadable=c;a.texteditor.setValue(JSON.stringify(g_wbconfig));}}}]});this.texteditor=Ext.create('Ext.form.field.TextArea',{title:'json',autoScroll:true,width:Ext.getCmp('centerpanel').getWidth(),height:Ext.getCmp('centerpanel').getHeight(),value:JSON.stringify(g_wbconfig),listeners:{change:{fn:function(b,c,d,e){g_wbconfig=JSON.parse(c);a.editor.setTitle('WBConfig*');}}}});var d=Ext.create('Ext.tab.Panel',{title:'WBConfig',tabPosition:'bottom',defaults:{bodyPadding:6},items:[c,this.texteditor],closable:'true'});this.editor=d;}TempConfigEditor.prototype.show_setting_mapping_window=function(a,b,c){var d=this;var e=true;if(a.type=='template_diagram')e=false;else e=true;var f=Ext.create('Ext.data.Store',{fields:['disp','type'],data:[{"disp":"テンプレート","type":"template"},{"disp":"テンプレート（ダイアグラム）","type":"template_diagram"},{"disp":"コピー","type":"copy"}]});var g=Ext.create('Ext.window.Window',{title:'mapping',height:240,width:360,layout:'vbox',items:[{xtype:'combo',fieldLabel:'type',store:f,queryMode:'local',displayField:'disp',valueField:'type',value:a.type,listeners:{scope:this,'select':function(b,c,d){a.type=b.getValue();if(a.type=='template_diagram'){}else{}}}},{xtype:'textfield',fieldLabel:'src',value:a.src,listeners:{scope:this,'change':function(b,c,e,f){a.src=c;d.texteditor.setValue(JSON.stringify(g_wbconfig));}}},{xtype:'textfield',fieldLabel:'dest',value:a.dest,listeners:{scope:this,'change':function(b,c,e,f){a.dest=c;d.texteditor.setValue(JSON.stringify(g_wbconfig));}}},{hidden:e,xtype:'numberfield',fieldLabel:'diagram',value:a.diagram,listeners:{scope:this,'change':function(b,c,e,f){a.diagram=c;d.texteditor.setValue(JSON.stringify(g_wbconfig));}}},{xtype:'button',text:'OK',handler:function(){g.hide();if(c!=null)c(a.type,a.src,a.dest);d.texteditor.setValue(JSON.stringify(g_wbconfig));}}]});g.show();};TempConfigEditor.prototype.show_setting_mappings_window=function(a){var b=this;var c=null;var d=Ext.create('Ext.grid.Panel',{border:false,columns:[{text:"type",dataIndex:'type'},{text:"src",dataIndex:'src'},{text:"dest",dataIndex:'dest'}],store:Ext.create('Ext.data.Store',{data:a.mapping,fields:['type','src','dest']}),sm:Ext.create('Ext.selection.RowModel',{singleSelect:true}),dockedItems:[{xtype:'toolbar',dock:'bottom',ui:'footer',layout:{pack:'center'},items:[]},{xtype:'toolbar',width:480,items:[{text:'add',tooltip:'add',iconCls:'add',handler:function(){b.show_setting_mapping_window({},a.mapping,function(c,e,f){var g={type:c,src:e,dest:f};var h=a.mapping.length;a.mapping.push(g);d.getStore().insert(h,g);b.texteditor.setValue(JSON.stringify(g_wbconfig));});}},{text:'update',tooltip:'update',iconCls:'add',handler:function(){var c=d.getSelectionModel().getSelection()[0].index;if(c==undefined)alert("コンフィグを開きなおしてください。");else b.show_setting_mapping_window(a.mapping[c],a.mapping,function(a,b,e){d.getStore().getAt(c).set('type',a);d.getStore().getAt(c).set('src',b);d.getStore().getAt(c).set('dest',e);});}},{text:'delete',tooltip:'delete',iconCls:'add',handler:function(){var c=d.getSelectionModel().getSelection()[0];var e=c.index;if(e==undefined)alert("コンフィグを開きなおしてください。");else{alert(''+a.mapping[e].type+','+a.mapping[e].src+',');a.mapping.splice(e,1);d.getStore().remove(c);b.texteditor.setValue(JSON.stringify(g_wbconfig));}}},{xtype:'checkbox',fieldLabel:'download',checked:a.downloadable,listeners:{scope:this,'change':function(b,c,d,e){a.downloadable=c;}}},{xtype:'checkbox',fieldLabel:'runnable',checked:a.runnable,listeners:{scope:this,'change':function(b,c,d,e){a.runnable=c;}}},{xtype:'checkbox',fieldLabel:'deploy',checked:a.deploy,listeners:{scope:this,'change':function(b,c,d,e){a.deploy=c;}}}]}]});var c=Ext.create('Ext.window.Window',{title:'target',height:240,width:480,layout:'fit',items:[d]});c.show();};TempConfigEditor.prototype.save=function(){var a=this;$.post('/tcsave',{id:g_metaproject.id,tc:JSON.stringify(g_wbconfig)},function(b){if(b)a.editor.setTitle('WBConfig');},"json");};TempConfigEditor.prototype.getPanel=function(){return this.editor;};TempConfigEditor.prototype.Initialize=function(){};TempConfigEditor.prototype.onActivate=function(){current_editor=this;};function TemplateEditor(a){this.template=a;this.resource=a;var b=this;var c='"width:'+(Ext.getCmp('centerpanel').getWidth()-40)+'px;height:'+Ext.getCmp('centerpanel').getHeight()+'px;"';this.panel=Ext.create('Ext.panel.Panel',{title:a.name,layout:{type:'hbox',align:'center'},items:[{html:'<textarea id="templatetextarea_'+a.name+'" style='+c+'>'+a.content+'</textarea>'}],closable:'true'});}TemplateEditor.prototype.save=function(){var a=this;Ext.MessageBox.show({title:'Please wait',msg:'Loading...',progressText:'Initializing...',width:300,progress:true,closable:false,animEl:'mb6'});this.template.content=this.template.content.replace(/\t/g,"  ");$.post('/template/save',{id:g_metaproject.id,fname:this.template.name,target:this.template.path,content:this.template.content},function(b){if(b)a.panel.setTitle(a.template.name);Ext.MessageBox.hide();},"json");};TemplateEditor.prototype.getPanel=function(){return this.panel;};TemplateEditor.prototype.Initialize=function(){var a=this;var b=document.getElementById('templatetextarea_'+this.template.name);b.parentNode.style.backgroundColor='#EEC';b.parentNode.style.color='#000';var c=CodeMirror.fromTextArea(b,{lineNumbers:true,onChange:function(b,c){a.template.content=b.getValue();a.panel.setTitle(a.template.name+'*');}});};TemplateEditor.prototype.onActivate=function(){current_editor=this;current_resource=this.resource;};function WellcomeMessageEditor(){this.resource=g_metaproject.welcome_message;var a=this;var b=Ext.create('Ext.panel.Panel',{title:'welcomemessage',layout:{type:'hbox',align:'center'},items:[{xtype:'textarea',autoScroll:true,width:Ext.getCmp('centerpanel').getWidth(),height:Ext.getCmp('centerpanel').getHeight(),value:g_metaproject.welcome_message,listeners:{change:{fn:function(a,c,d,e){g_metaproject.welcome_message=c;b.setTitle('welcomemessage*');}}}}],closable:'true'});this.editor=b;}WellcomeMessageEditor.prototype.save=function(){var a=this;$.post('/welsave',{id:g_metaproject.id,welcome_message:g_metaproject.welcome_message},function(b){if(b)a.editor.setTitle('welcomemessage');},"json");};WellcomeMessageEditor.prototype.getPanel=function(){return this.editor;};WellcomeMessageEditor.prototype.Initialize=function(){};WellcomeMessageEditor.prototype.onActivate=function(){current_editor=this;};Ext.require(['Ext.panel.*','Ext.toolbar.*','Ext.button.*','Ext.container.ButtonGroup','Ext.layout.container.Table','Ext.tab.Panel']);function init_wb(a){g_toolinfo=a;new Ext.Viewport({layout:'border',items:[new Ext.Panel({id:'centerpanel',html:'',width:'100px',region:'center',layout:'fit',items:[create_tabs()]}),new Ext.Panel({margins:'0 3 0 3',region:'north',items:[create_menu()]}),new Ext.Panel({id:'propertypanel',html:'',margins:'3 3 3 3',region:'south',collapsible:true,split:true,items:[]}),new Ext.Panel({id:'toolpanel',title:'ヘルプ',html:'未使用パネル',margins:'0 3 0 3',region:'east',collapsible:true,layout:{type:'vbox',align:'stretch',pack:'start'},items:[{xtype:'button',html:'はじめに',handler:function(){var a=new Ext.Window({width:320,height:480,title:'はじめに',html:'',modal:true});a.show('anime');}},{xtype:'button',html:'メタモデルを定義',handler:function(){var a=new Ext.Window({width:320,height:480,title:'メタモデルを定義',html:'',modal:true});a.show('anime');}},{xtype:'button',html:'プロパティを追加',handler:function(){var a=new Ext.Window({width:320,height:480,title:'プロパティを追加',html:'',modal:true});a.show('anime');}},{xtype:'button',html:'オブジェクトを追加',handler:function(){var a=new Ext.Window({width:320,height:480,title:'オブジェクトを追加',html:'',modal:true});a.show('anime');}},{xtype:'button',html:'ダイアグラムを追加',handler:function(){var a=new Ext.Window({width:320,height:480,title:'ダイアグラムを追加',html:'',modal:true});a.show('anime');}}]}),new Ext.Panel({id:'modelexplorer',title:'WEST',html:'WEST PANEL',margins:'0 0 0 3',region:'west',collapsible:true,split:true,items:[]})]});wb_loadMetaModel(id);}function create_tabs(){editortabpanel=new EditorTabPanel();return editortabpanel.getPanel();}function create_menu(){return{tbar:[{xtype:'splitbutton',text:'ファイル',iconCls:'add16',menu:[{text:'未実装',iconCls:'add16',handler:onItemClick}],handler:onItemClick},'-',{id:'save',text:'保存',iconCls:'add16',handler:onItemClick},{text:'ワークベンチ',iconCls:'add16',menu:[{id:'preview',text:'プレビュー（未実装）',iconCls:'add16',handler:onItemClick},{id:'metajson',text:'メタモデル',iconCls:'add16',handler:onItemClick},{id:'welcome_editor',text:'ウェルカムメッセージ',iconCls:'add16',handler:onItemClick},{id:'config',text:'コンフィグ',iconCls:'add16',handler:onItemClick}]},{text:'テンプレート',iconCls:'add16',menu:[{id:'new',text:'新規作成',iconCls:'add16',handler:onTempItemClick},{id:'import',text:'インポート',iconCls:'add16',handler:onTempItemClick},{id:'export',text:'エクスポート',iconCls:'add16',handler:onTempItemClick}]},{id:'tool-name',html:''}]};}function onItemClick(a){if(a.id=='save')editortabpanel.current_editor.save();else if(a.id=='preview')if(check_metamodel())window.open('/wb/preview/'+g_metaproject.id);else alert("メタモデルに問題があります。");else if(a.id=='metajson'){var b=new MetaJSONEditor(g_metamodel.metadiagrams);editortabpanel.add(b,'metajson');}else if(a.id=='welcome_editor'){var b=new WellcomeMessageEditor();editortabpanel.add(b,'welcome_editor');}else if(a.id=='targets'){}else if(a.id=='config'){var b=new TempConfigEditor();editortabpanel.add(b,'tempconfig');}}function onTempItemClick(a){if(a.id=='new'){Ext.Msg.prompt('','',function(a,b){if(a!='cancel')create_new_template(b);},null,false);}else if(a.id=='import'){Ext.Msg.prompt('','',function(a,b){if(a!='cancel')import_template(b);},null,true);}else if(a.id=='export')window.open('/template/export/'+g_metaproject.id);}function export_template(){$.post('/template/tree',{id:g_metaproject.id},function(a){if(a){}},"json");}function import_template(a){$.post('/template/import',{id:g_metaproject.id,text:a},function(a){if(a)load_templates();},"json");}function load_templates(){$.post('/template/tree',{id:g_metaproject.id},function(a){if(a){g_templates=a;createTemplateExplorer();}},"json");}function create_new_template(a,b){$.post('/template/new',{id:g_metaproject.id,fname:a,path:b},function(a){if(a)load_templates();},"json");}function save_template(a,b,c){$.post('/template/save',{id:g_metaproject.id,fname:a,target:b,content:c},function(a){if(a){}},"json");}function del_template(a,b){$.post('/template/del',{id:g_metaproject.id,fname:a,target:b},function(a){if(a)load_templates();},"json");}function createTemplateExplorer(){Ext.getCmp('modelexplorer').removeAll();var a=[];if(g_wbconfig.targets==undefined)g_wbconfig.targets=[];for(var b=0;b<g_wbconfig.targets.length;b++)a.push({text:g_wbconfig.targets[b].name,children:[]});for(var b=0;b<g_templates.length;b++){var c=g_templates[b].name;var d=g_templates[b].path;for(var e=0;e<a.length;e++)if(a[e].text==d){a[e].children.push({id:b,text:c,leaf:true});break;}}var f=Ext.create('Ext.data.TreeStore',{root:{expanded:true,children:[{text:"templates",expanded:true,children:a,root:true}]}});var g=Ext.create('Ext.tree.Panel',{title:'Template Explorer',width:200,height:200,store:f,rootVisible:false});g.on('itemdblclick',function(a,b,c,d,e){if(b.data.leaf){var f=g_templates[b.data.id];editor=new TemplateEditor(f);editortabpanel.add(editor,f.path+':'+f.name);}});var h=new Ext.menu.Menu({items:[{id:'new_target',text:'ターゲット作成'}],listeners:{click:function(a,b){switch(b.id){case 'new_target':Ext.Msg.prompt('','',function(a,b){if(a!='cancel')if(b.length!=0){g_wbconfig.targets.push({name:b,mapping:[]});$.post('/tcsave',{id:g_metaproject.id,tc:JSON.stringify(g_wbconfig)},function(a){if(a)createTemplateExplorer();},"json");}},null,false);break;}}}});var i=new Ext.menu.Menu({items:[{id:'new',text:'新規作成'}],listeners:{click:function(a,b){switch(b.id){case 'new':Ext.Msg.prompt('','',function(a,b){if(a!='cancel')create_new_template(b,selected_item.text);},null,false);break;}}}});var j=new Ext.menu.Menu({items:[{id:'delete',text:'削除'}],listeners:{click:function(a,b){switch(b.id){case 'delete':del_template(g_templates[selected_item.id].name,g_templates[selected_item.id].path);break;}}}});g.on('itemmousedown',function(a,b,c,d,e){if(e.button==2){if(b.data.root)h.showAt(e.getX(),e.getY());else if(b.data.leaf!=true)i.showAt(e.getX(),e.getY());else j.showAt(e.getX(),e.getY());selected_item=b.data;console.log(selected_item.id+','+selected_item.text+','+d);}});Ext.getCmp('modelexplorer').add(g);return g;}function show_targets_window(){Ext.Msg.prompt('ターゲット','編集',function(a,b){if(a!='cancel')g_metaproject.targets=JSON.parse(b);},null,true,JSON.stringify(g_metaproject.targets));}function WBConfig(){this.targets=[];}function WBTarget(a){this.name=a;this.mapping=[];}function WBMap(){this.type='';this.src='';this.dest='';}